# Claude AI Assistant Rules

## üö® CRITICAL: CANONICAL PROJECT DIRECTORY (MANDATORY)

**THE ONLY VALID PROJECT DIRECTORY IS:**
```
/Users/hichamnaim/Downloads/Cursor/VITAL path/
```

### NEVER Work In These Directories:
- ‚ùå `/Users/hichamnaim/Downloads/Cursor/VITAL/` (ARCHIVED - DO NOT USE)
- ‚ùå Any other `VITAL` directory without the space in the name

### Why This Matters:
- All code, documentation, and configuration has been consolidated into `VITAL path`
- The `VITAL` directory (without space) contains outdated/archived code
- Working in the wrong directory causes fragmentation and lost work

### Before ANY Operation:
1. **Verify your working directory** is `VITAL path` (with space)
2. **Never create files** in `/Users/hichamnaim/Downloads/Cursor/VITAL/`
3. **Never edit files** in `/Users/hichamnaim/Downloads/Cursor/VITAL/`
4. If asked to work on VITAL, **always use `VITAL path`**

---

## üîç ASK EXPERT SERVICE - E2E AUDIT (December 11, 2025)

**Audit Date**: December 11, 2025 22:45 CET
**Server Version**: 2.0.0
**Health Status**: ‚úÖ Healthy (supabase, agent_orchestrator, rag_pipeline, unified_rag_service)
**Canonical Tenant**: `00000000-0000-0000-0000-000000000001`
**Agent Count**: 1,212 active agents (L1:34, L2:335, L3:636, L4:136, L5:71)
**Mission Templates**: 23+ templates (deep_dive, regulatory_analysis, case_building, etc.)

### Mode Architecture

| Mode | Type | Endpoints | Description |
|------|------|-----------|-------------|
| **Mode 1** | Interactive Manual | `/api/expert/interactive` OR `/api/expert/stream` | User selects agent |
| **Mode 2** | Interactive Auto | `/api/expert/interactive` OR `/api/expert/stream` | Mode 1 + GraphRAG fusion search |
| **Mode 3** | Autonomous Manual | `/ask-expert/autonomous` | Template-based deep research |
| **Mode 4** | Autonomous Auto | `/ask-expert/autonomous` | Mode 3 + GraphRAG fusion search |

**Key Insight**: Mode 2 = Mode 1 + Fusion Search, Mode 4 = Mode 3 + Fusion Search
**Endpoint Note**: Both `/api/expert/interactive` and `/api/expert/stream` use SSE streaming

### Mode Status Summary

| Mode | Name | Status | Grade | Root Cause |
|------|------|--------|-------|------------|
| **Mode 1** | Interactive Manual | ‚ùå Broken | D (40%) | `user_id` NOT NULL constraint - missing x-user-id header extraction |
| **Mode 2** | Interactive Auto-Select | ‚úÖ **WORKING** | A- (90%) | GraphRAG fusion + SSE streaming + full LLM response (462+ tokens) |
| **Mode 3** | Autonomous Manual | ‚ö†Ô∏è Partial | C (60%) | `user_id` NOT NULL constraint on missions table |
| **Mode 4** | Autonomous Auto-Select | ‚ö†Ô∏è Partial | C (60%) | Same as Mode 3 + fusion search |

**Overall Service Grade**: B- (72/100)

### Critical Bug: user_id Extraction

**Both Mode 1 and Mode 3/4 fail with the same root cause:**
- Error: `null value in column "user_id" of relation "..." violates not-null constraint`
- The backend doesn't extract `user_id` from request headers (x-user-id) or session
- This affects: `conversations` table (Mode 1) and `missions` table (Mode 3/4)

### Detailed Endpoint Status

#### Working Endpoints ‚úÖ

| Endpoint | Method | Status | Notes |
|----------|--------|--------|-------|
| `/health` | GET | ‚úÖ | All services healthy |
| `/ask-expert/agents/select` | POST | ‚úÖ | GraphRAG fusion returns L1-L5 agents |
| `/api/expert/interactive` (mode=2) | POST | ‚úÖ | SSE streaming, auto-selects agents |
| `/ask-expert/missions/templates` | GET | ‚úÖ | Returns 23+ mission templates |
| `/ask-expert/consultations` | GET | ‚úÖ | Returns consultation history |

#### Broken/Partial Endpoints ‚ö†Ô∏è

| Endpoint | Method | Issue | Fix Required |
|----------|--------|-------|--------------|
| `/api/expert/interactive` (mode=1) | POST | `invalid input syntax for type uuid: "None"` | Extract user_id from auth/session headers |
| `/ask-expert/autonomous` | POST | Requires `template_id` + `goal`, not `message` | Different schema than interactive modes |
| `/ask-expert/missions` (POST) | POST | `Cannot coerce the result to a single JSON object` | Template lookup issue |

### GraphRAG Fusion Search (Mode 2)

**Working Features**:
- ‚úÖ Weighted combination: PostgreSQL (30%), Pinecone (50%), Neo4j (20%)
- ‚úÖ Returns agents with proper L1-L5 level mapping
- ‚úÖ Tenant-aware filtering
- ‚úÖ SSE streaming with agent_selected event

**Sample Response**:
```json
{
  "agents": [
    {"id": "...", "name": "Regulatory Strategy Advisor", "score": 0.0125, "level": "L3"},
    {"id": "...", "name": "Regulatory Strategy Master", "score": 0.0119, "level": "L1"}
  ]
}
```

### Mode 3/4 (Autonomous) Implementation

**Schema Requirements**:
```json
{
  "template_id": "regulatory_analysis",   // REQUIRED
  "goal": "Analyze FDA 510k requirements", // REQUIRED
  "agent_id": "uuid"                       // Optional (auto-select if omitted)
}
```

**Status**: Endpoints exist but require template-based invocation, not simple message like Mode 1/2.

### Required Fixes (Priority Order)

1. **CRITICAL**: Fix `user_id` extraction across all modes
   - **Location**: `src/api/routes/ask_expert.py`, `src/api/routes/missions.py`
   - **Fix**: Extract from `request.headers.get("x-user-id")` or JWT token
   - **Fallback**: Use a system/anonymous user UUID for unauthenticated requests
   - **Affects**: Mode 1, Mode 3, Mode 4 (all except Mode 2)
2. **MEDIUM**: Improve Mode 3/4 error messages to clarify `template_id` + `goal` required
3. **LOW**: Add v2 convenience endpoints if needed

### Key Files

| File | Purpose |
|------|---------|
| `src/api/routes/ask_expert.py` | Interactive & autonomous routes |
| `src/api/routes/missions.py` | Mission CRUD + templates |
| `src/services/graphrag_selector.py` | GraphRAG fusion search |
| `src/workflows/` | LangGraph workflow implementations |

### Test Commands

```bash
# Health check
curl http://localhost:8000/health

# GraphRAG Agent Selection (WORKING - used by Mode 2/4)
curl -X POST "http://localhost:8000/ask-expert/agents/select" \
  -H "Content-Type: application/json" \
  -H "x-tenant-id: 00000000-0000-0000-0000-000000000001" \
  -d '{"query": "FDA regulatory approval", "top_k": 5}'

# Mode 2 via /api/expert/interactive (WORKING ‚úÖ - verified Dec 11, 2025 22:45)
curl -X POST "http://localhost:8000/api/expert/interactive" \
  -H "Content-Type: application/json" \
  -H "x-tenant-id: 00000000-0000-0000-0000-000000000001" \
  -d '{"mode": 2, "message": "What is FDA 510k clearance?", "session_id": "test-m2"}'

# Mode 2 via /api/expert/stream (WORKING ‚úÖ - same functionality, SSE streaming)
curl -X POST "http://localhost:8000/api/expert/stream" \
  -H "Content-Type: application/json" \
  -H "x-tenant-id: 00000000-0000-0000-0000-000000000001" \
  -d '{"mode": 2, "message": "What is FDA accelerated approval?", "session_id": "test"}'

# Mode 1 via /api/expert/interactive (BROKEN ‚ùå - user_id extraction bug)
curl -X POST "http://localhost:8000/api/expert/interactive" \
  -H "Content-Type: application/json" \
  -H "x-tenant-id: 00000000-0000-0000-0000-000000000001" \
  -d '{"mode": 1, "agent_id": "dad2f053-7d05-4aba-9f1e-bb0779921e1e", "message": "Hello", "session_id": "test-m1"}'

# Mode 3/4 Autonomous (requires template - user_id bug affects missions table)
curl -X POST "http://localhost:8000/ask-expert/autonomous" \
  -H "Content-Type: application/json" \
  -H "x-tenant-id: 00000000-0000-0000-0000-000000000001" \
  -d '{"template_id": "regulatory_analysis", "goal": "Analyze FDA 510k", "agent_id": "UUID"}'

# Get Mission Templates
curl "http://localhost:8000/ask-expert/missions/templates?limit=5"
```

---

## üö´ CRITICAL: FILE CREATION RESTRICTIONS (MANDATORY)

### ‚ùå NEVER CREATE FILES IN THESE LOCATIONS:
```
‚ùå / (project root) - NO .md, .sql, .py, .ts, .json files
‚ùå /docs/ - Reserved for PUBLIC developer documentation only
‚ùå /scripts/ root - Use /scripts/codegen/, /scripts/build/, etc.
‚ùå /apps/ root - Use proper feature directories
‚ùå /services/ root - Use /services/ai-engine/src/ subdirectories
‚ùå Any random location not in the approved structure
```

### ‚úÖ APPROVED FILE LOCATIONS:

| File Type | Correct Location |
|-----------|------------------|
| **Internal Documentation** | `/.claude/docs/` (organized by category) |
| **Public Developer Docs** | `/docs/guides/`, `/docs/api/`, `/docs/architecture/` |
| **Service Documentation** | `/.claude/docs/services/{service-name}/` |
| **SQL Migrations** | `/database/migrations/` |
| **RLS Policies** | `/database/policies/` |
| **Python Backend Code** | `/services/ai-engine/src/{module}/` |
| **Frontend Code** | `/apps/vital-system/src/{feature}/` |
| **Build Scripts** | `/scripts/codegen/`, `/scripts/build/` |
| **Test Files** | `/tests/`, `/services/ai-engine/tests/` |
| **Config Files** | Project root (only standard configs) |

### Before Creating ANY File:
1. ‚úÖ **CHECK** if it belongs in `/.claude/docs/` (internal) or `/docs/` (public)
2. ‚úÖ **VERIFY** the correct subdirectory exists
3. ‚úÖ **SEARCH** for existing similar files first
4. ‚úÖ **ASK** if unsure about the correct location
5. ‚ùå **NEVER** create temporary files in project root
6. ‚ùå **NEVER** create documentation outside designated folders

### Documentation Location Rules:

```
/.claude/docs/                    # INTERNAL comprehensive docs
‚îú‚îÄ‚îÄ architecture/                 # Architecture decisions & standards
‚îú‚îÄ‚îÄ services/                     # Service-specific PRDs & ARDs
‚îÇ   ‚îú‚îÄ‚îÄ ask-expert/              # Ask Expert documentation
‚îÇ   ‚îî‚îÄ‚îÄ ask-panel/               # Ask Panel documentation
‚îú‚îÄ‚îÄ platform/                     # Platform features (agents, personas)
‚îú‚îÄ‚îÄ operations/                   # Deployment, security, monitoring
‚îú‚îÄ‚îÄ coordination/                 # Agent coordination guides
‚îî‚îÄ‚îÄ strategy/                     # Business strategy & vision

/docs/                            # PUBLIC developer-facing docs ONLY
‚îú‚îÄ‚îÄ api/                         # OpenAPI specification
‚îú‚îÄ‚îÄ architecture/                # System overview (high-level)
‚îî‚îÄ‚îÄ guides/                      # Getting started, deployment
```

### Enforcement:
- **ALL AI assistants MUST follow these rules**
- **Violations will cause project fragmentation**
- **When in doubt, ASK the user for the correct location**

---

## üî¥ CRITICAL: Evidence-Based Operation (MANDATORY)

**READ FIRST**: `.vital-docs/EVIDENCE_BASED_RULES.md`

### Core Principles

1. **NO CLAIMS WITHOUT EVIDENCE**
   - NEVER say "working", "complete", "implemented", or "operational" without verification
   - ALWAYS provide tool output, terminal results, or file verification
   - NEVER estimate progress by lines of code - use working features only

2. **DISTINGUISH CODE STATES**
   - Written (files exist) ‚â† Runnable (executes) ‚â† Working (correct results)
   - Only claim "complete" when code is tested and produces correct results
   - Always state which level you've actually achieved

3. **VERIFY BEFORE REPORTING**
   - Run `list_dir` to confirm files exist
   - Run code to confirm it executes
   - Run tests to confirm it works correctly
   - Show actual output in your response

4. **HONEST PROGRESS REPORTING**
   ```
   Progress = (Working Features / Total Features) √ó 100
   NOT: (Files Created / Total Files) √ó 100
   NOT: (Lines Written / Estimated Lines) √ó 100
   ```

5. **MANDATORY EVIDENCE FORMAT**
   ```markdown
   ## Claim
   [Your claim]
   
   ## Evidence
   ```bash
   [Actual tool output]
   ```
   
   ## Verification
   [How evidence proves claim]
   ```

6. **IF YOU MAKE UNVERIFIED CLAIMS**
   - Acknowledge immediately
   - Provide honest correction
   - Show actual evidence
   - Apologize and commit to verification going forward

**See `.vital-docs/EVIDENCE_BASED_RULES.md` for complete guidelines**

---

## Critical Database Safety Rules

### NEVER Reset or Replace Data Without Approval
**CRITICAL**: Before running ANY database reset or data replacement commands, you MUST:

1. ‚úÖ **Verify a recent backup exists** in `/database/backups/`
2. ‚úÖ **Get explicit user approval** by asking the user directly
3. ‚úÖ **Confirm the backup is recent** (within the last 24 hours)
4. ‚úÖ **ALL UPDATES MUST BE INCREMENTAL** - never replace existing work

### Prohibited Commands Without Approval
- `npx supabase db reset`
- `DROP DATABASE`
- `DROP TABLE` (on production tables)
- `TRUNCATE TABLE` (deletes all data)
- Any command that recreates the entire database schema
- Any migration that uses `CASCADE` on core tables
- Any script that imports data with UPSERT/replace behavior
- Any bulk DELETE or UPDATE without WHERE clauses

### UPDATE Philosophy: Incremental Only
**ALL agent updates MUST:**
- ‚úÖ Preserve existing agent data (display_name, description, system_prompt)
- ‚úÖ Only ADD missing fields (evidence, metadata, new columns)
- ‚úÖ Only UPDATE specific fields that need correction
- ‚úÖ Use WHERE clauses to target specific agents
- ‚úÖ Never replace all agents with new imports
- ‚úÖ Never reset status to 'active' without reviewing each agent

### Safe Database Operations
These are allowed without special approval:
- Reading data (`SELECT`, `curl GET requests`)
- Creating new tables (not dropping existing ones)
- Adding columns with `ALTER TABLE ... ADD COLUMN IF NOT EXISTS`
- Creating backups
- Reading migration files
- **UPDATE with WHERE clause** targeting specific agents
- **INSERT** for new agents only (check if exists first)

### Before Any Destructive Database Operation
Ask the user:
```
‚ö†Ô∏è  WARNING: This operation will [describe what will be destroyed]

I found a backup from [date/time]: [backup_file_name]

Do you want me to proceed with this operation?
```

### Backup Protocol
- Always check for backups in `/database/backups/` before destructive operations
- Create a new backup if the latest is older than 1 hour
- Use the backup script: `./scripts/backup-db.sh`

## Project-Specific Rules

### Migration Files
- Migrations are stored in `/supabase/migrations/`
- NOT in `/database/sql/migrations/` (that's just documentation)
- Always create migration files in the correct location

### Schema Cache Issues
- PostgREST caches schema - restart container if needed: `docker restart supabase_rest_VITAL_path`
- Don't immediately assume a field doesn't exist - check the actual database schema first

### Field Validation Before Insert
- Before inserting data, verify fields exist in the database schema
- Don't rely solely on TypeScript types - they may be outdated
- Use metadata/JSONB fields for storing extra data if specific columns don't exist

### Agent Avatar Icons
- **ALWAYS use icon files from `/public/icons/png/avatars/` directory**
- Icon paths should be stored as: `/icons/png/avatars/avatar_XXXX.png`
- DO NOT use emoji characters (üè•, üì±, etc.) for avatars
- There are 200+ avatar icons available (avatar_0001.png through avatar_0200.png)
- Assign avatars based on agent specialization and theme
- When creating or updating agents, map them to appropriate avatar files

### Agent Tier-Appropriate Avatars
- **Tier 1 (Foundational):** avatar_0109-0193
- **Tier 2 (Specialist):** avatar_0200-0314
- **Tier 3 (Ultra-Specialist):** avatar_0400-0449

## Agent Quality Standards

### Evidence-Based Model Selection (MANDATORY)
**Every agent MUST have:**

1. **model_justification** (required, stored in metadata)
   - Why this specific model was chosen
   - What benchmarks/performance metrics support the choice
   - What specific use case requirements drove the decision
   - Format: "Ultra-specialist/Specialist/Foundational requiring [accuracy level] for [domain]. [Model] achieves [X%] on [Benchmark]. Critical/Important for [outcome]."

2. **model_citation** (required, stored in metadata)
   - Academic source (arXiv, DOI, official documentation)
   - Must be accessible and verifiable
   - Standard citations:
     - GPT-4: "OpenAI (2023). GPT-4 Technical Report. arXiv:2303.08774"
     - GPT-3.5-Turbo: "OpenAI (2023). GPT-3.5 Turbo Documentation. https://platform.openai.com/docs/models/gpt-3-5-turbo"
     - Claude 3 Opus: "Anthropic (2024). Claude 3 Model Card. https://www.anthropic.com/news/claude-3-family"
     - BioGPT: "Luo et al. (2022). BioGPT. DOI:10.1093/bib/bbac409"
     - CuratedHealth/meditron70b-qlora-1gpu: "HuggingFace CuratedHealth. Medical fine-tuned 70B model. https://huggingface.co/CuratedHealth/meditron70b-qlora-1gpu"
     - CuratedHealth/Qwen3-8B-SFT-20250917123923: "HuggingFace CuratedHealth. Medical supervised fine-tuned 8B model. https://huggingface.co/CuratedHealth/Qwen3-8B-SFT-20250917123923"
     - CuratedHealth/base_7b: "HuggingFace CuratedHealth. Medical base 7B model. https://huggingface.co/CuratedHealth/base_7b"

3. **Tier-Model Alignment** (enforce strictly)
   ```
   Tier 3 (Ultra-Specialist):
   - Models: GPT-4 ($0.35/query), Claude-3-Opus ($0.40/query), OR CuratedHealth/meditron70b-qlora-1gpu ($0.10/query)
   - Temperature: 0.2
   - Max tokens: 4000
   - Context window: 16000
   - Accuracy target: >95%
   - Use case: Safety-critical, complex reasoning, regulatory compliance, medical diagnosis

   Tier 2 (Specialist):
   - Models: GPT-4 ($0.12/query), GPT-4-Turbo ($0.10/query), CuratedHealth/Qwen3-8B-SFT-20250917123923 ($0.06/query), OR BioGPT ($0.08/query)
   - Temperature: 0.4
   - Max tokens: 3000
   - Context window: 8000
   - Accuracy target: 90-95%
   - Use case: Specialized expertise, domain-specific tasks, medical/clinical workflows

   Tier 1 (Foundational):
   - Models: GPT-3.5-Turbo ($0.015/query), CuratedHealth/base_7b ($0.02/query), OR BioGPT ($0.02/query)
   - Temperature: 0.6
   - Max tokens: 2000
   - Context window: 4000
   - Accuracy target: 85-90%
   - Use case: High-volume, foundational queries, medical triage, escalates to specialists
   ```

### Safety-Critical Agent Requirements
**For agents handling clinical decisions, dosing, drug interactions, or patient safety:**

1. **MUST use Tier-3 models** (GPT-4 or Claude-3-Opus)
   - NO EXCEPTIONS - patient safety is non-negotiable
   - Examples: Dosing Calculator, Drug Interaction Checker, Pediatric Dosing Specialist

2. **MUST have EVIDENCE REQUIREMENTS section** in system_prompt
   - Always cite clinical sources
   - Use evidence hierarchy (Level 1A > 1B > 2A > 2B > 3)
   - Acknowledge uncertainty explicitly
   - Never make medical recommendations without supporting evidence

3. **MUST have safety flags enabled**
   - hipaa_compliant: true
   - audit_trail_enabled: true
   - data_classification: "confidential"

### System Prompt Structure (6-Section Framework)
**All agent system prompts MUST include:**

1. **YOU ARE:** [Specific role and unique positioning]
2. **YOU DO:** [3-7 specific capabilities with measurable outcomes]
3. **YOU NEVER:** [3-5 safety-critical boundaries with rationale]
4. **SUCCESS CRITERIA:** [Measurable performance targets]
5. **WHEN UNSURE:** [Escalation protocol with confidence thresholds]
6. **EVIDENCE REQUIREMENTS:** [For medical/regulated agents - MANDATORY]
   - What sources to cite
   - Evidence level hierarchy
   - When to acknowledge uncertainty
   - Confidence score requirements

### Agent Creation/Update Checklist
Before creating or updating an agent, verify:
- [ ] Tier assignment is appropriate for task complexity
- [ ] Model matches tier requirements
- [ ] model_justification includes specific benchmarks
- [ ] model_citation is accessible (arXiv/DOI/official docs)
- [ ] temperature, max_tokens, context_window are tier-appropriate
- [ ] cost_per_query is calculated correctly
- [ ] System prompt follows 6-section framework
- [ ] Safety flags set for medical/regulated agents
- [ ] Avatar is tier-appropriate (Tier 1: 0109-0193, Tier 2: 0200-0314, Tier 3: 0400-0449)

### Cost Optimization Guidelines
**Before assigning expensive models, ask:**
1. Is >95% accuracy truly REQUIRED? (If no, don't use Tier-3)
2. Is this safety-critical? (If yes, use Tier-3 regardless of cost)
3. Is this biomedical/pharmaceutical? (Consider BioGPT for cost savings)
4. Is this high-volume? (Use Tier-1 models for foundational tasks)

**Cost reference:**
- GPT-4 (Tier-3): $0.35/query (use sparingly, for ultra-specialists)
- Claude-3-Opus (Tier-3): $0.40/query (best reasoning, ultra-specialists)
- GPT-4 (Tier-2): $0.12/query (specialists only)
- CuratedHealth/meditron70b-qlora-1gpu: $0.10/query (medical Tier-3 specialists)
- CuratedHealth/Qwen3-8B-SFT-20250917123923: $0.06/query (medical Tier-2 specialists)
- BioGPT: $0.08/query (biomedical specialists, cost-effective)
- CuratedHealth/base_7b: $0.02/query (medical Tier-1 foundational)
- GPT-3.5-Turbo: $0.015/query (foundational, high-volume)

### Never Do These (Common Mistakes)
- ‚ùå Using Tier-3 models without evidence/justification
- ‚ùå Using GPT-4 for Tier-1 foundational tasks (15x more expensive than GPT-3.5-Turbo)
- ‚ùå Using gpt-4o-mini for Tier-3 ultra-specialists (wrong model tier)
- ‚ùå Skipping model_citation (required for all agents)
- ‚ùå Missing EVIDENCE REQUIREMENTS for medical/clinical agents
- ‚ùå Creating agents without system prompts following the 6-section framework
- ‚ùå Activating agents that haven't been validated

## Phase 2: Standardization Guidelines (Active)

### System Prompt Generation (Batch Processing)

**Current Status:** Phase 1 Complete (9 agents upgraded)
**Next Phase:** Generate unique prompts for remaining 240+ agents

**Batch Strategy:**
1. **Batch 1: Remaining Active Agents (16 agents)** - Add evidence first
2. **Batch 2: Tier-3 Review (80+ agents)** - Audit tier/model alignment
3. **Batch 3: Tier-2 Specialists (170+ agents)** - Systematic evidence addition
4. **Batch 4: Persona Assignment** - Assign all agents to archetypes

**Evidence Template Library:**
```javascript
// Use these templates for batch evidence addition
const EVIDENCE_TEMPLATES = {
  'gpt-4': {
    tier3: {
      justification: 'Ultra-specialist requiring highest accuracy for [DOMAIN]. GPT-4 achieves 86.7% on MedQA (USMLE) and 86.4% on MMLU. Critical for [USE_CASE].',
      citation: 'OpenAI (2023). GPT-4 Technical Report. arXiv:2303.08774',
      temperature: 0.2,
      max_tokens: 4000,
      context_window: 16000,
      cost_per_query: 0.35
    },
    tier2: {
      justification: 'High-accuracy specialist for [DOMAIN]. GPT-4 achieves 86.7% on MedQA (USMLE). Balanced performance for specialist tasks.',
      citation: 'OpenAI (2023). GPT-4 Technical Report. arXiv:2303.08774',
      temperature: 0.4,
      max_tokens: 3000,
      context_window: 8000,
      cost_per_query: 0.12
    }
  },
  'gpt-3.5-turbo': {
    tier1: {
      justification: 'Fast, cost-effective for foundational [DOMAIN] queries. GPT-3.5 Turbo achieves 70% on HumanEval. Ideal for high-volume, low-complexity queries.',
      citation: 'OpenAI (2023). GPT-3.5 Turbo Documentation. https://platform.openai.com/docs/models/gpt-3-5-turbo',
      temperature: 0.6,
      max_tokens: 2000,
      context_window: 4000,
      cost_per_query: 0.015
    }
  },
  'microsoft/biogpt': {
    tier2: {
      justification: 'Cost-effective biomedical specialist. BioGPT achieves F1 0.849 on BC5CDR (chemical-disease relations), 81.2% on PubMedQA. Optimized for [biomedical task].',
      citation: 'Luo et al. (2022). BioGPT: Generative Pre-trained Transformer for Biomedical Text Generation and Mining. DOI:10.1093/bib/bbac409',
      temperature: 0.4,
      max_tokens: 3000,
      context_window: 8000,
      cost_per_query: 0.08
    },
    tier1: {
      justification: 'Fast, cost-effective biomedical responses. BioGPT achieves F1 0.849 on BC5CDR, 81.2% on PubMedQA. Optimized for high-volume foundational queries.',
      citation: 'Luo et al. (2022). BioGPT. DOI:10.1093/bib/bbac409',
      temperature: 0.6,
      max_tokens: 2000,
      context_window: 4000,
      cost_per_query: 0.02
    }
  },
  'claude-3-opus': {
    tier3: {
      justification: 'Best-in-class code generation and complex reasoning. Claude 3 Opus achieves 84.5% pass@1 on HumanEval. Excellent for [use case].',
      citation: 'Anthropic (2024). Claude 3 Model Card. https://www.anthropic.com/news/claude-3-family',
      temperature: 0.2,
      max_tokens: 4000,
      context_window: 16000,
      cost_per_query: 0.40
    }
  }
};
```

### Persona Archetypes (10 Core Types)

**Assign each agent to one of these personas:**

1. **Clinical Expert** - Medical/pharmaceutical specialists
   - Tone: Professional, evidence-focused, compassionate
   - Example: Pharmacist, Clinical Trials Designer

2. **Regulatory Authority** - FDA, EMA, compliance specialists
   - Tone: Formal, compliance-focused, precise
   - Example: FDA Regulatory Strategist, HIPAA Officer

3. **Data Analyst** - Metrics, analytics, insights
   - Tone: Data-driven, quantitative, objective
   - Example: Quality Metrics Analyst, Market Intelligence

4. **Safety Officer** - Risk, adverse events, pharmacovigilance
   - Tone: Cautious, thorough, risk-focused
   - Example: Adverse Event Reporter, Drug Interaction Checker

5. **Research Specialist** - Clinical trials, R&D
   - Tone: Scientific, methodical, evidence-based
   - Example: Clinical Trial Designer, Biostatistician

6. **Business Strategist** - Commercial, market access
   - Tone: Strategic, business-focused, ROI-oriented
   - Example: Reimbursement Strategist, Market Access

7. **Operations Manager** - Manufacturing, supply chain, QA
   - Tone: Process-oriented, efficiency-focused, practical
   - Example: Manufacturing Specialist, Quality Assurance

8. **Compliance Guardian** - Legal, regulatory compliance
   - Tone: Risk-averse, detail-oriented, policy-focused
   - Example: HIPAA Compliance, Data Privacy

9. **Innovation Advisor** - Digital health, technology
   - Tone: Forward-thinking, tech-savvy, solution-oriented
   - Example: Digital Health specialists, AI/ML experts

10. **Patient Advocate** - Patient engagement, education
    - Tone: Accessible, empathetic, health-literacy focused
    - Example: Patient Engagement Platform Advisor

### Batch Processing Scripts (Templates)

**Script Pattern for Evidence Addition:**
```javascript
// scripts/add-evidence-batch-[tier].js
async function addEvidenceToBatch(agents, tier) {
  for (const agent of agents) {
    const template = EVIDENCE_TEMPLATES[agent.model]?.[`tier${tier}`];
    if (!template) continue;

    const justification = template.justification
      .replace('[DOMAIN]', agent.domain_expertise || agent.knowledge_domains[0])
      .replace('[USE_CASE]', agent.description.split('.')[0])
      .replace('[biomedical task]', agent.capabilities[0]);

    await supabase.from('agents').update({
      model: agent.model,
      temperature: template.temperature,
      max_tokens: template.max_tokens,
      context_window: template.context_window,
      cost_per_query: template.cost_per_query,
      metadata: {
        ...agent.metadata,
        model_justification: justification,
        model_citation: template.citation
      }
    }).eq('id', agent.id);
  }
}
```

### Next Actions (Week 2)

**Priority Order:**
1. ‚úÖ Add evidence to 16 remaining active agents (scripts/add-evidence-to-remaining-active.js)
2. ‚úÖ Review 80+ Tier-3 gpt-4o-mini agents (tier/model audit)
3. ‚úÖ Begin Tier-2 evidence addition (170+ agents, batch processing)
4. ‚úÖ Assign persona archetypes to all agents
5. ‚úÖ Generate unique system prompts using persona templates

## Database Schema Golden Rules üèÜ

### Role-Centric Architecture (MANDATORY)
**The Foundation of VITAL's Data Model:**

1. **Roles are Structural Truth**
   - Roles define: responsibilities, tools, budget, scope, JTBDs
   - Roles are tenant-agnostic blueprints (mapped via junction tables)
   - NEVER duplicate role data for each persona

2. **Personas are Behavioral Deltas**
   - Personas inherit ALL data from their role
   - Personas only store: overrides, additions, behavioral attributes
   - Use `is_additional` flag for additions, `overrides_role` flag for replacements

3. **Override Pattern (Core Principle)**
   ```
   Effective Data = Role Baseline + Persona Additions - Persona Overrides
   ```
   - Default: Persona inherits from role (no junction entry needed)
   - Addition: `is_additional = TRUE, overrides_role = FALSE`
   - Override: `is_additional = FALSE, overrides_role = TRUE`

4. **Query Using Effective Views**
   - NEVER query role + persona tables directly
   - ALWAYS use effective views: `v_effective_persona_*`
   - Views automatically combine role baseline + persona deltas

### Normalized Data Model (MANDATORY)

1. **No JSONB for Queryable Data**
   - JSONB allowed ONLY for experimental `metadata` fields
   - All multi-valued attributes MUST use junction tables
   - Never use arrays for responsibilities, tools, skills, stakeholders

2. **Junction Tables Pattern**
   ```sql
   -- Role baseline junction
   role_tools (role_id, tool_id, usage_frequency, proficiency_level, is_required)
   
   -- Persona override junction  
   persona_tools (persona_id, tool_id, proficiency_level, satisfaction_level, 
                  is_additional, overrides_role, sequence_order)
   ```

3. **Consistent Naming Conventions**
   - Tables: lowercase with underscores (`org_roles`, `persona_tools`)
   - Foreign keys: `{table_singular}_id` (`role_id`, `persona_id`)
   - Names: `{table_singular}_name` (`tool_name`, `skill_name`)
   - Flags: `is_*` or `has_*` (`is_additional`, `has_budget`)

### Evidence-Based Model (MANDATORY)

1. **All Attributes Must Be Traceable**
   - Use `evidence_sources` for publications, interviews, surveys
   - Use `evidence_links` for generic polymorphic linkage
   - Store confidence levels, methodology, sample size

2. **Evidence Requirements**
   ```sql
   evidence_sources (
     source_type,        -- publication | interview | survey | analytics
     title,
     citation,
     authors,
     publication_date,
     doi,
     url,
     confidence_level,   -- high | medium | low
     methodology
   )
   ```

### JTBD Integration (MANDATORY)

1. **JTBDs Belong to Roles, Not Personas**
   - Use `jtbd_roles` junction table (consolidates old `role_jtbd`)
   - Personas inherit JTBDs from roles (via `v_persona_jtbd_inherited` view)
   - Personas NEVER map directly to JTBDs
   - Keep structural jobs (role) separate from behavioral needs (persona)

2. **JTBD Table Contains ONLY Universal Job Attributes**
   - ‚úÖ Job identity: `code`, `name`, `job_statement`
   - ‚úÖ ODI format: `when_situation`, `circumstance`, `desired_outcome`
   - ‚úÖ Job characteristics: `job_type`, `complexity`, `frequency`
   - ‚úÖ Business context: `industry_id`, `domain_id`, `strategic_priority_id`
   - ‚ùå NO org structure columns (`function_id`, `role_id`, etc.) - use junctions
   - ‚ùå NO JSONB fields - fully normalized
   - ‚ùå NO arrays - use junction tables
   - ‚ùå NO workflow_id - workflows link TO jtbd

3. **ID + NAME Pattern for All JTBD Mappings**
   ```sql
   -- All JTBD mapping tables cache both ID and NAME
   jtbd_functions (jtbd_id, function_id, function_name, relevance_score)
   jtbd_departments (jtbd_id, department_id, department_name, relevance_score)
   jtbd_roles (jtbd_id, role_id, role_name, relevance_score, importance, frequency)
   ```
   - **Benefits:** Join-free queries, better performance, human-readable filtering
   - Auto-sync triggers keep names in sync with source tables
   - Query example: `WHERE function_name = 'Medical Affairs'` (no joins!)

4. **Zero JSONB for Structured JTBD Data**
   - All previously-JSONB fields now normalized:
     - `jtbd.kpis` ‚Üí `jtbd_kpis` table
     - `jtbd.pain_points` ‚Üí `jtbd_pain_points` table
     - `jtbd.desired_outcomes` ‚Üí `jtbd_desired_outcomes` table
     - `jtbd.success_criteria` ‚Üí `jtbd_success_criteria` table
   - JSONB allowed ONLY for experimental metadata

5. **Value Layer (First-Class Entity)**
   - **Value Categories:** Smarter, Faster, Better, Efficient, Safer, Scalable
   - **Value Drivers:** Internal (efficiency, quality, compliance) & External (HCP, patient, market)
   - **Mappings:** `jtbd_value_categories`, `jtbd_value_drivers` (with quantified impact)
   - Use views: `v_jtbd_complete` includes all value dimensions

6. **AI Layer (First-Class Entity)**
   - **AI Intervention Types:** Automation, Augmentation, Redesign
   - **AI Suitability:** Multi-dimensional scores (RAG, summary, generation, reasoning, etc.)
   - **AI Opportunities:** Consolidated from fragmented tables
   - **AI Use Cases:** Mapped to service layers (Ask Me, Ask Expert, Ask Panel, Workflows)
   - Table: `jtbd_ai_suitability` (one per JTBD with all scores)
   - Table: `ai_opportunities` (replaces old `jtbd_gen_ai_opportunities`)

7. **Unified Workflow System**
   - **Single canonical model** replaces 4 fragmented systems
   - Tables: `workflow_templates` ‚Üí `workflow_stages` ‚Üí `workflow_tasks`
   - Normalized task dependencies: `workflow_task_tools`, `workflow_task_skills`, `workflow_task_data_requirements`
   - Workflows link TO jtbd via `jtbd_id`, not vice versa

### Multi-Tenant Architecture (MANDATORY)

1. **Use Junction Tables for Tenant Mapping**
   - `function_tenants` - Functions mapped to tenants
   - `department_tenants` - Departments mapped to tenants
   - `role_tenants` - Roles mapped to tenants
   - `persona_tenants` - Personas mapped to tenants

2. **Never Hardcode tenant_id in Main Tables**
   - One role/function/department can serve multiple tenants
   - Use junction tables for many-to-many relationships

### MECE Persona Framework (MANDATORY)

**Each role MUST have exactly 4 MECE personas based on 2x2 matrix:**

```
                 Low Complexity    High Complexity
High AI Maturity    AUTOMATOR        ORCHESTRATOR
Low AI Maturity     LEARNER          SKEPTIC
```

**Differentiating Attributes:**
- `ai_maturity_score` (0-100)
- `work_complexity_score` (0-100)
- `seniority_level` (entry | mid | senior | director | executive)
- `years_of_experience`
- `geographic_scope` (local | regional | global)
- `gen_ai_readiness_level`

### Schema Modification Rules

1. **NEVER Recreate Existing Tables**
   - Use `ALTER TABLE ADD COLUMN IF NOT EXISTS`
   - Use `CREATE TABLE IF NOT EXISTS`
   - Always check for existing tables first

2. **NEVER Drop Tables Without Backup**
   - Create backup script first
   - Get explicit user approval
   - Use soft delete (`deleted_at`) instead of DROP

3. **Idempotent Scripts Only**
   - All scripts must be runnable multiple times
   - Use conditional logic: `IF NOT EXISTS`, `IF EXISTS`
   - Include ROLLBACK procedures

## File Organization Golden Rules üìÅ

### Mandatory File Structure

**NEVER create files outside these designated locations:**

```
.vital-docs/vital-expert-docs/10-data-schema/
‚îú‚îÄ‚îÄ 01-core-schema/          ‚Üê DDL for evidence, references, roles
‚îú‚îÄ‚îÄ 02-role-junctions/       ‚Üê Role baseline junction tables
‚îú‚îÄ‚îÄ 03-persona-junctions/    ‚Üê Persona delta junction tables
‚îú‚îÄ‚îÄ 04-views/                ‚Üê Effective views (role + persona)
‚îú‚îÄ‚îÄ 05-seeds/                ‚Üê Seed data templates
‚îÇ   ‚îú‚îÄ‚îÄ tenants/            ‚Üê Tenant templates & examples
‚îÇ   ‚îú‚îÄ‚îÄ functions/          ‚Üê Function templates per industry
‚îÇ   ‚îú‚îÄ‚îÄ departments/        ‚Üê Department templates per function
‚îÇ   ‚îú‚îÄ‚îÄ roles/              ‚Üê Role templates per department
‚îÇ   ‚îî‚îÄ‚îÄ personas/           ‚Üê Persona templates (4 MECE per role)
‚îú‚îÄ‚îÄ 06-migrations/          ‚Üê Version-controlled schema changes
‚îú‚îÄ‚îÄ 07-utilities/           ‚Üê Helper scripts
‚îÇ   ‚îú‚îÄ‚îÄ verification/       ‚Üê Data quality checks
‚îÇ   ‚îú‚îÄ‚îÄ cleanup/            ‚Üê Maintenance scripts
‚îÇ   ‚îî‚îÄ‚îÄ diagnostics/        ‚Üê Troubleshooting queries
‚îú‚îÄ‚îÄ GOLD_STANDARD_SCHEMA.md       ‚Üê Master schema documentation
‚îú‚îÄ‚îÄ NAMING_CONVENTIONS.md         ‚Üê Database naming standards
‚îî‚îÄ‚îÄ INHERITANCE_PATTERN.md        ‚Üê Override pattern explained
```

### File Creation Rules

**Before creating ANY file, check:**

1. **Does this file type have a designated location?**
   - SQL schema ‚Üí `01-core-schema/`, `02-role-junctions/`, `03-persona-junctions/`, `04-views/`
   - SQL seeds ‚Üí `05-seeds/{tenants,functions,departments,roles,personas}/`
   - SQL migrations ‚Üí `06-migrations/`
   - SQL utilities ‚Üí `07-utilities/{verification,cleanup,diagnostics}/`
   - Documentation ‚Üí Same folder as related code

2. **Can I edit an existing file instead?**
   - ALWAYS prefer editing over creating
   - Search for existing files first: `glob_file_search`

3. **Is this a temporary/diagnostic file?**
   - Use `07-utilities/diagnostics/` for one-off queries
   - Archive after use, don't leave in root

### Prohibited File Locations

**NEVER create files in these locations:**

- ‚ùå Project root (`/Users/hichamnaim/Downloads/Cursor/VITAL path/`)
- ‚ùå Random subdirectories
- ‚ùå Duplicate folders (don't create `/sql/` if `/10-data-schema/` exists)

### File Naming Conventions

1. **SQL Files**
   - Schema: `create_*.sql` or `enhance_*.sql`
   - Seeds: `seed_*.sql` or `populate_*.sql`
   - Migrations: `YYYYMMDD_descriptive_name.sql`
   - Utilities: `verify_*.sql`, `fix_*.sql`, `diagnose_*.sql`

2. **Documentation Files**
   - Guides: `*_GUIDE.md`, `*_PATTERN.md`
   - Status: `*_STATUS.md`, `*_SUMMARY.md`
   - Templates: `*_template.md`, `*_TEMPLATE.md`

3. **Archive Convention**
   - Move obsolete files to `_archive/old-implementations/`
   - Include date in archive folder: `_archive/2025-11-21/`

### Seed Data Standards

**When creating seed data:**

1. **Use Templates First**
   - Check `05-seeds/` for existing templates
   - Customize templates, don't create from scratch

2. **Include Full Context**
   - Tenant ID and name
   - Function ID and name
   - Department ID and name
   - Role ID and name

3. **Follow Industry Standards**
   - Pharmaceuticals: 15 functions, 9 Medical Affairs departments
   - Use standard role names from templates
   - Generate 4 MECE personas per role

### Documentation Updates

**When updating schema, ALWAYS update:**

1. `GOLD_STANDARD_SCHEMA.md` - Master schema doc
2. `IMPLEMENTATION_COMPLETE_SUMMARY.md` - Status tracking
3. Relevant README files in affected directories
4. Seed templates if structure changed

## General Coding Rules

### File Creation
- NEVER create documentation files unless explicitly requested
- ALWAYS prefer editing existing files over creating new ones
- ALWAYS use designated file locations (see File Organization Golden Rules above)
- Only create files that are absolutely necessary
- Archive obsolete files, don't delete

### Communication
- Be concise and direct
- Minimize output tokens while maintaining helpfulness
- No unnecessary preamble or postamble

### Tool Usage
- Use specialized tools (Read, Edit, Write) instead of bash for file operations
- Batch independent tool calls together in a single message
- Use TodoWrite for complex multi-step tasks
- Check file locations before creating: `glob_file_search`, `list_dir`
