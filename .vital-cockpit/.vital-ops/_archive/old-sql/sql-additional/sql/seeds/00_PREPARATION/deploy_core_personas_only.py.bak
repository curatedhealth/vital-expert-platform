#!/usr/bin/env python3
"""
Deploy ONLY Core Personas Table - Simplified
=============================================
Deploy just the main personas table without v5.0 extensions
"""

import json
import sys
from datetime import datetime
from typing import Dict, List, Any

TENANT_ID = "f7aa6fd4-0af9-4706-8b31-034f1f7accda"
INPUT_FILE = "/Users/hichamnaim/Downloads/Medical_Affairs_Personas_V5_EXTENDED.json"
OUTPUT_FILE = "/Users/hichamnaim/Downloads/Cursor/VITAL path/sql/seeds/00_PREPARATION/DEPLOY_CORE_PERSONAS_ONLY.sql"

def escape_sql_string(value: Any, force_jsonb: bool = False) -> str:
    """Escape strings for SQL"""
    if value is None:
        return "NULL"
    if isinstance(value, bool):
        return "TRUE" if value else "FALSE"
    if isinstance(value, (int, float)):
        return str(value)
    if isinstance(value, list):
        if not value:
            return "'[]'::jsonb" if force_jsonb else "ARRAY[]::TEXT[]"
        if force_jsonb or isinstance(value[0], dict):
            json_str = json.dumps(value).replace("'", "''")
            return f"'{json_str}'::jsonb"
        else:
            escaped = [f"'{str(v).replace(chr(39), chr(39)+chr(39))}'" for v in value]
            return f"ARRAY[{', '.join(escaped)}]"
    if isinstance(value, dict):
        json_str = json.dumps(value).replace("'", "''")
        return f"'{json_str}'::jsonb"
    escaped = str(value).replace("'", "''")
    return f"'{escaped}'"

def generate_persona_insert(persona: Dict, idx: int) -> str:
    """Generate INSERT for personas table only"""
    core = persona.get('core_profile', {})
    prof = persona.get('professional_context', {})
    
    # Get responsibilities - schema expects TEXT[]
    responsibilities = persona.get('responsibilities', [])
    if not responsibilities and prof.get('key_responsibilities'):
        responsibilities = prof.get('key_responsibilities', [])
    if responsibilities and isinstance(responsibilities[0], dict):
        responsibilities = [r.get('responsibility', str(r)) for r in responsibilities]
    
    # Build metadata with all extra fields
    metadata = {
        'age': core.get('age'),
        'location': core.get('location'),
        'education_level': core.get('education_level'),
    }
    
    name = core.get('name', f'Persona {idx}')
    slug = core.get('slug', name.lower().replace(' ', '-'))
    title = prof.get('title', 'Professional')
    
    sql = f"""
-- Persona {idx}: {name}
INSERT INTO personas (
    id, tenant_id, name, slug, title, tagline,
    role_id, function_id, department_id,
    seniority_level, years_of_experience,
    key_responsibilities, pain_points, goals, challenges,
    preferred_tools, communication_preferences,
    decision_making_style, tags, metadata,
    is_active, validation_status
) VALUES (
    gen_random_uuid(),
    {escape_sql_string(TENANT_ID)}::uuid,
    {escape_sql_string(name)},
    {escape_sql_string(slug)},
    {escape_sql_string(title)},
    {escape_sql_string(core.get('tagline', ''))},
    (SELECT id FROM org_roles WHERE slug = 'medical-affairs-leader' LIMIT 1),
    (SELECT id FROM org_functions WHERE slug = 'medical-affairs' LIMIT 1),
    (SELECT id FROM org_departments WHERE slug = 'medical-affairs' LIMIT 1),
    {escape_sql_string(prof.get('seniority_level', 'senior'))},
    {escape_sql_string(prof.get('years_of_experience', 10))},
    {escape_sql_string(responsibilities)},
    {escape_sql_string(persona.get('pain_points', []), force_jsonb=True)},
    {escape_sql_string(persona.get('goals', []), force_jsonb=True)},
    {escape_sql_string(persona.get('challenges', []), force_jsonb=True)},
    ARRAY[]::TEXT[],
    '{{}}'::jsonb,
    {escape_sql_string(prof.get('decision_making_style', 'analytical'))},
    ARRAY[]::TEXT[],
    {escape_sql_string(metadata)}::jsonb,
    TRUE,
    'validated'
);
"""
    return sql

def main():
    print(f"Reading JSON from: {INPUT_FILE}")
    with open(INPUT_FILE, 'r') as f:
        data = json.load(f)
    
    personas = data.get('personas', [])
    print(f"Found {len(personas)} personas")
    
    sql_output = f"""-- ===================================================================
-- VITAL Medical Affairs Personas - CORE ONLY
-- ===================================================================
-- Generated: {datetime.now().isoformat()}
-- Personas: {len(personas)}
-- Tables: 1 (personas only - no v5.0 extensions)
-- ===================================================================

BEGIN;

"""
    
    for idx, persona in enumerate(personas, 1):
        name = persona.get('core_profile', {}).get('name', f'Persona {idx}')
        print(f"Processing persona {idx}/{len(personas)}: {name}")
        sql_output += generate_persona_insert(persona, idx)
    
    sql_output += """
-- ===================================================================
-- VERIFICATION
-- ===================================================================

DO $$
DECLARE
    v_count INTEGER;
BEGIN
    SELECT COUNT(*) INTO v_count
    FROM personas
    WHERE tenant_id = 'f7aa6fd4-0af9-4706-8b31-034f1f7accda';
    
    RAISE NOTICE '✅ Deployed % personas', v_count;
END $$;

COMMIT;
"""
    
    print(f"\nWriting SQL to: {OUTPUT_FILE}")
    with open(OUTPUT_FILE, 'w') as f:
        f.write(sql_output)
    
    print(f"\n✅ SUCCESS!")
    print(f"Generated: {OUTPUT_FILE}")
    print(f"Personas: {len(personas)}")
    print(f"\nNext steps:")
    print(f"1. Deploy: psql \"YOUR_CONNECTION_STRING\" -f {OUTPUT_FILE}")
    print(f"2. Verify personas in database")
    print(f"3. Fix v5.0 extension table schemas incrementally")

if __name__ == '__main__':
    main()
