# Docker Compose for Neo4j Local Development
#
# Usage:
#   Start: docker-compose -f docker-compose.neo4j.yml up -d
#   Stop: docker-compose -f docker-compose.neo4j.yml down
#   Logs: docker-compose -f docker-compose.neo4j.yml logs -f neo4j
#
# Access:
#   Neo4j Browser: http://localhost:7474
#   Bolt Protocol: bolt://localhost:7687
#   Default credentials: neo4j / development-password

version: '3.8'

services:
  neo4j:
    image: neo4j:5.15-community
    container_name: vital-neo4j
    restart: unless-stopped
    ports:
      - "7474:7474"  # HTTP (Neo4j Browser)
      - "7687:7687"  # Bolt protocol
    environment:
      # Authentication
      - NEO4J_AUTH=neo4j/development-password

      # Memory settings (adjust based on your system)
      - NEO4J_server_memory_heap_initial__size=512m
      - NEO4J_server_memory_heap_max__size=2G
      - NEO4J_server_memory_pagecache_size=1G

      # APOC plugin (advanced procedures)
      - NEO4J_PLUGINS=["apoc", "graph-data-science"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*,gds.*

      # Performance settings
      - NEO4J_dbms_transaction_timeout=30s
      - NEO4J_dbms_lock_acquisition_timeout=20s
      - NEO4J_dbms_connector_bolt_thread__pool__max__size=400

      # Enable vector indexes (for embeddings)
      - NEO4J_db_vector_enabled=true
    volumes:
      # Persist data
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/import
      - neo4j_plugins:/plugins
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    networks:
      - vital-network

  # Optional: Redis for caching (if not already running)
  redis:
    image: redis:7-alpine
    container_name: vital-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - vital-network

volumes:
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  neo4j_import:
    driver: local
  neo4j_plugins:
    driver: local
  redis_data:
    driver: local

networks:
  vital-network:
    driver: bridge

# ==================== Production Notes ====================
#
# For production, use Neo4j AuraDB (managed service) instead:
# 1. Create Neo4j Aura account: https://neo4j.com/cloud/aura/
# 2. Provision database (recommended: 4GB RAM, 2 cores)
# 3. Configure network access (whitelist Railway IPs)
# 4. Set environment variables in .env:
#    NEO4J_URI=neo4j+s://xxxxx.databases.neo4j.io
#    NEO4J_USER=neo4j
#    NEO4J_PASSWORD=<secure-password>
#
# Cost estimate: $500/month for production workload
#
# ==================== Initial Setup ====================
#
# After starting Neo4j:
# 1. Access Neo4j Browser: http://localhost:7474
# 2. Login with: neo4j / development-password
# 3. Run migration script:
#    python scripts/migrations/migrate_agents_to_neo4j.py
# 4. Verify agents:
#    MATCH (a:Agent) RETURN count(a)
# 5. Test graph query:
#    MATCH (a:Agent {tenant_id: '<your-tenant-id>'})
#    RETURN a.name, a.capabilities
#    LIMIT 10
