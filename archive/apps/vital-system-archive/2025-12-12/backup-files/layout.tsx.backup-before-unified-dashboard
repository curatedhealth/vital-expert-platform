'use client'

import React, { useEffect } from 'react'
import dynamic from 'next/dynamic'
import { useRouter, usePathname } from 'next/navigation'
import { AgentsFilterProvider } from '@/contexts/agents-filter-context'
import { AskExpertProvider } from '@/contexts/ask-expert-context'
import { useAuth } from '@/lib/auth/supabase-auth-context'

// Dynamically import ClientSideLayout with SSR disabled to avoid styled-jsx errors
const ClientSideLayout = dynamic(
  () => import('./client-layout').then((mod) => mod.ClientSideLayout),
  {
    ssr: false,
    loading: () => (
      <div className="flex h-screen items-center justify-center">
        <div className="text-center">
          <div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent" />
          <p className="mt-2 text-sm text-muted-foreground">Loading...</p>
        </div>
      </div>
    )
  }
)

function AppLayoutContent({ children }: { children: React.ReactNode }) {
  const { user, loading, userProfile } = useAuth()
  const router = useRouter()
  const pathname = usePathname()

  // Redirect to login if not authenticated
  useEffect(() => {
    if (!loading && !user && !userProfile) {
      if (!pathname.startsWith('/login') && !pathname.startsWith('/auth')) {
        router.push('/login')
      }
    }
  }, [user, loading, userProfile, router, pathname])

  // Show loading state
  if (loading) {
    return (
      <div className="flex h-screen items-center justify-center">
        <div className="text-center">
          <div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent" />
          <p className="mt-2 text-sm text-muted-foreground">Loading...</p>
        </div>
      </div>
    )
  }

  // User authentication logic
  let displayUser = null
  if (user) {
    displayUser = user
  } else if (userProfile) {
    displayUser = {
      ...userProfile,
      email: userProfile.email || user?.email,
      user_metadata: { name: userProfile.full_name || userProfile.email }
    }
  } else if (process.env.NODE_ENV === 'development') {
    displayUser = {
      id: 'dev-user',
      email: 'dev@vitalexpert.com',
      user_metadata: { name: 'Development User' }
    }
  }

  if (!displayUser && process.env.NODE_ENV === 'production') {
    return null
  }

  return (
    <ClientSideLayout>
      {children}
    </ClientSideLayout>
  )
}

export default function AppLayout({ children }: { children: React.ReactNode }) {
  return (
    <AskExpertProvider>
      <AgentsFilterProvider>
        <AppLayoutContent>{children}</AppLayoutContent>
      </AgentsFilterProvider>
    </AskExpertProvider>
  )
}
