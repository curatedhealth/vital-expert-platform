# ============================================================================
# VITAL Platform - Prometheus Configuration
# ============================================================================

global:
  scrape_interval: 15s      # Scrape targets every 15 seconds
  evaluation_interval: 15s  # Evaluate rules every 15 seconds
  scrape_timeout: 10s

  external_labels:
    cluster: 'vital-production'
    environment: '${ENVIRONMENT:-development}'

# ============================================================================
# ALERTING
# ============================================================================

alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

# ============================================================================
# RULE FILES
# ============================================================================

rule_files:
  - '/etc/prometheus/alerts/*.yml'

# ============================================================================
# SCRAPE CONFIGS
# ============================================================================

scrape_configs:
  # --------------------------------------------------------------------------
  # Prometheus itself
  # --------------------------------------------------------------------------
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: 'prometheus'

  # --------------------------------------------------------------------------
  # PostgreSQL Database
  # --------------------------------------------------------------------------
  - job_name: 'postgresql'
    static_configs:
      - targets: ['postgres-exporter:9187']
        labels:
          service: 'postgresql'
          instance: 'vital-db'

    # Custom metrics from PostgreSQL
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: 'pg_(database|stat|locks|replication).*'
        action: keep

  # --------------------------------------------------------------------------
  # Redis Cache
  # --------------------------------------------------------------------------
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
        labels:
          service: 'redis'
          instance: 'vital-cache'

  # --------------------------------------------------------------------------
  # Node Exporter (System Metrics)
  # --------------------------------------------------------------------------
  - job_name: 'node'
    static_configs:
      - targets: ['node-exporter:9100']
        labels:
          service: 'node-exporter'
          instance: 'vital-host'

  # --------------------------------------------------------------------------
  # Python AI Services (FastAPI)
  # --------------------------------------------------------------------------
  - job_name: 'python-ai-services'
    static_configs:
      - targets: ['host.docker.internal:8000']
        labels:
          service: 'python-ai-services'
          component: 'backend'

    # Scrape /metrics endpoint
    metrics_path: '/metrics'

    # Only keep application metrics
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: '(http|vital|search|evidence|recommendation).*'
        action: keep

  # --------------------------------------------------------------------------
  # Next.js Frontend (if exposed)
  # --------------------------------------------------------------------------
  - job_name: 'nextjs-frontend'
    static_configs:
      - targets: ['host.docker.internal:3000']
        labels:
          service: 'nextjs'
          component: 'frontend'

    metrics_path: '/api/metrics'

  # --------------------------------------------------------------------------
  # LangFuse (LLM Observability)
  # --------------------------------------------------------------------------
  - job_name: 'langfuse'
    static_configs:
      - targets: ['langfuse-server:3000']
        labels:
          service: 'langfuse'
          component: 'observability'

    metrics_path: '/api/public/metrics'

# ============================================================================
# CUSTOM VITAL PLATFORM QUERIES
# ============================================================================

# The following queries can be used in Grafana dashboards:
#
# Search Performance:
#   - rate(vital_search_requests_total[5m])
#   - histogram_quantile(0.9, rate(vital_search_duration_seconds_bucket[5m]))
#
# Evidence Detection:
#   - rate(vital_evidence_detected_total[5m])
#   - vital_evidence_confidence_score
#
# HITL Review Queue:
#   - vital_review_queue_pending
#   - vital_review_queue_sla_breached
#
# Compliance:
#   - vital_compliance_violations_total
#   - vital_compliance_audit_events_total
#
# Recommendations:
#   - rate(vital_recommendations_generated_total[5m])
#   - vital_recommendation_click_through_rate
#
# Cache Performance:
#   - vital_cache_hit_rate
#   - redis_connected_clients
#
# Database Performance:
#   - pg_stat_database_tup_fetched
#   - pg_stat_database_tup_inserted
#   - rate(pg_stat_database_xact_commit[5m])
