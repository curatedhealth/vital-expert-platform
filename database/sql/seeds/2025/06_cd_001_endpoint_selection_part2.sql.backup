-- =====================================================================================
-- 06_cd_001_endpoint_selection_part2.sql
-- UC-01: DTx Clinical Endpoint Selection - Part 2: Assignments
-- =====================================================================================
-- Purpose: Seed all task assignments for UC-01
-- Dependencies: 06_cd_001_endpoint_selection_part1.sql (workflows and tasks)
-- Execution Order: 6.2 (after part1)
-- =====================================================================================
-- 
-- ASSIGNMENTS STRUCTURE:
-- - Task Dependencies (13 tasks with sequential dependencies)
-- - Task-Agent Assignments (AI execution)
-- - Task-Persona Assignments (human review/approval)
-- - Task-Tool Mappings (resources)
-- - Task-RAG Source Mappings (knowledge base)
-- =====================================================================================

-- =====================================================================================
-- SECTION 0: TENANT LOOKUP & SESSION CONFIGURATION
-- =====================================================================================

DO $$
DECLARE
  v_tenant_id UUID;
  v_tenant_slug TEXT := 'digital-health-startup';
BEGIN
  SELECT id INTO v_tenant_id 
  FROM tenants 
  WHERE slug = v_tenant_slug;
  
  IF v_tenant_id IS NULL THEN
    RAISE EXCEPTION 'Tenant with slug "%" not found. Please create tenant first.', v_tenant_slug;
  END IF;
  
  RAISE NOTICE 'Using tenant: % (ID: %)', v_tenant_slug, v_tenant_id;
END $$;

CREATE TEMP TABLE IF NOT EXISTS session_config (
  tenant_id UUID,
  tenant_slug TEXT
);

DELETE FROM session_config;

INSERT INTO session_config (tenant_id, tenant_slug)
SELECT id, slug 
FROM tenants 
WHERE slug = 'digital-health-startup';

-- =====================================================================================
-- SECTION 1: TASK DEPENDENCIES
-- =====================================================================================
-- UC_CD_001 has 13 tasks across 5 phases with sequential dependencies

INSERT INTO dh_task_dependency (
  tenant_id,
  task_id,
  depends_on_task_id,
  note
)
SELECT 
  sc.tenant_id,
  t1.id as task_id,
  t2.id as depends_on_task_id,
  dep_data.note
FROM session_config sc
CROSS JOIN (
  VALUES
    -- Phase 1 dependencies (Tasks 1-2)
    ('TSK-CD-001-P1-02', 'TSK-CD-001-P1-01', 'Sequential: Patient outcomes depend on clinical context'),
    
    -- Phase 2 depends on Phase 1 (Tasks 3-4 depend on Task 2)
    ('TSK-CD-001-P2-01', 'TSK-CD-001-P1-02', 'Sequential: Precedent research requires patient outcome priorities'),
    ('TSK-CD-001-P2-02', 'TSK-CD-001-P2-01', 'Sequential: PRO evaluation follows precedent research'),
    
    -- Phase 3 depends on Phase 2 (Tasks 5-6 depend on Task 4)
    ('TSK-CD-001-P3-01', 'TSK-CD-001-P2-02', 'Sequential: Digital biomarker assessment follows PRO evaluation'),
    ('TSK-CD-001-P3-02', 'TSK-CD-001-P3-01', 'Sequential: Comparator analysis requires endpoint candidates'),
    
    -- Phase 4 depends on Phase 3 (Tasks 7-9 depend on Task 6)
    ('TSK-CD-001-P4-01', 'TSK-CD-001-P3-02', 'Sequential: Endpoint scoring requires complete candidate analysis'),
    ('TSK-CD-001-P4-02', 'TSK-CD-001-P4-01', 'Sequential: Power analysis follows endpoint selection'),
    ('TSK-CD-001-P4-03', 'TSK-CD-001-P4-02', 'Sequential: Justification incorporates power analysis'),
    
    -- Phase 5 depends on Phase 4 (Tasks 10-13 depend on Task 9)
    ('TSK-CD-001-P5-01', 'TSK-CD-001-P4-03', 'Sequential: Measurement schedule follows endpoint justification'),
    ('TSK-CD-001-P5-02', 'TSK-CD-001-P5-01', 'Sequential: Validation strategy requires measurement schedule'),
    ('TSK-CD-001-P5-03', 'TSK-CD-001-P5-02', 'Sequential: Risk assessment incorporates validation plan'),
    ('TSK-CD-001-P5-04', 'TSK-CD-001-P5-03', 'Sequential: Final recommendation includes all prior analyses')
) AS dep_data(task_code, depends_on_code, note)
INNER JOIN dh_task t1 ON t1.code = dep_data.task_code AND t1.tenant_id = sc.tenant_id
INNER JOIN dh_task t2 ON t2.code = dep_data.depends_on_code AND t2.tenant_id = sc.tenant_id
ON CONFLICT (task_id, depends_on_task_id) 
DO UPDATE SET
  note = EXCLUDED.note;

-- =====================================================================================
-- SECTION 2: TASK-AGENT ASSIGNMENTS
-- =====================================================================================
-- Assign AI agents to tasks with proper assignment types

INSERT INTO dh_task_agent (
  tenant_id,
  task_id,
  agent_id,
  assignment_type,
  execution_order,
  requires_human_approval,
  max_retries,
  retry_strategy,
  is_parallel,
  approval_persona_code,
  approval_stage,
  on_failure,
  metadata
)
SELECT 
  sc.tenant_id,
  t.id as task_id,
  a.id as agent_id,
  agent_data.assignment_type,
  agent_data.execution_order,
  agent_data.requires_human_approval,
  agent_data.max_retries,
  agent_data.retry_strategy,
  agent_data.is_parallel,
  agent_data.approval_persona_code,
  agent_data.approval_stage,
  agent_data.on_failure,
  agent_data.metadata
FROM session_config sc
CROSS JOIN (
  VALUES
    -- Task 1: Define Clinical Context (P1-01)
    ('TSK-CD-001-P1-01', 'AGT-CLINICAL-ENDPOINT', 'PRIMARY_EXECUTOR', 1, true, 2, 'EXPONENTIAL_BACKOFF', false, 'P01_CMO', 'AFTER_EXECUTION', 'ESCALATE_TO_HUMAN', '{"role": "Lead clinical context analysis", "focus": "Clinical problem definition"}'::jsonb),
    ('TSK-CD-001-P1-01', 'AGT-REGULATORY-STRATEGY', 'CO_EXECUTOR', 2, false, 2, 'LINEAR', true, NULL, NULL, 'RETRY', '{"role": "Provide regulatory perspective", "focus": "FDA precedent"}'::jsonb),
    
    -- Task 2: Identify Patient-Centered Outcomes (P1-02)
    ('TSK-CD-001-P1-02', 'AGT-CLINICAL-ENDPOINT', 'PRIMARY_EXECUTOR', 1, true, 2, 'EXPONENTIAL_BACKOFF', false, 'P10_PATADV', 'AFTER_EXECUTION', 'ESCALATE_TO_HUMAN', '{"role": "Identify patient outcomes", "focus": "Patient-centered analysis"}'::jsonb),
    ('TSK-CD-001-P1-02', 'AGT-LITERATURE-SEARCH', 'CO_EXECUTOR', 2, false, 2, 'LINEAR', true, NULL, NULL, 'RETRY', '{"role": "Patient outcomes value", "focus": "HEOR perspective"}'::jsonb),
    
    -- Task 3: Research Regulatory Precedent (P2-01)
    ('TSK-CD-001-P2-01', 'AGT-REGULATORY-INTELLIGENCE', 'PRIMARY_EXECUTOR', 1, true, 3, 'EXPONENTIAL_BACKOFF', false, 'P04_REGDIR', 'AFTER_EXECUTION', 'ESCALATE_TO_HUMAN', '{"role": "Lead precedent research", "focus": "FDA approvals analysis"}'::jsonb),
    ('TSK-CD-001-P2-01', 'AGT-LITERATURE-SEARCH', 'CO_EXECUTOR', 2, false, 2, 'LINEAR', true, NULL, NULL, 'RETRY', '{"role": "Literature search", "focus": "Clinical trial endpoints"}'::jsonb),
    ('TSK-CD-001-P2-01', 'AGT-QUALITY-VALIDATOR', 'VALIDATOR', 3, false, 2, 'LINEAR', false, NULL, NULL, 'RETRY', '{"role": "Validate precedent accuracy", "focus": "Source verification"}'::jsonb),
    
    -- Task 4: Evaluate PRO Instruments (P2-02)
    ('TSK-CD-001-P2-02', 'AGT-CLINICAL-ENDPOINT', 'PRIMARY_EXECUTOR', 1, true, 2, 'EXPONENTIAL_BACKOFF', false, 'P02_VPCLIN', 'AFTER_EXECUTION', 'ESCALATE_TO_HUMAN', '{"role": "Evaluate PRO properties", "focus": "Psychometric validation"}'::jsonb),
    ('TSK-CD-001-P2-02', 'AGT-LITERATURE-SEARCH', 'CO_EXECUTOR', 2, false, 2, 'LINEAR', true, NULL, NULL, 'RETRY', '{"role": "PRO literature review", "focus": "Validation evidence"}'::jsonb),
    
    -- Task 5: Assess Digital Biomarker Feasibility (P3-01)
    ('TSK-CD-001-P3-01', 'AGT-BIOSTATISTICS', 'PRIMARY_EXECUTOR', 1, true, 2, 'EXPONENTIAL_BACKOFF', false, 'P07_DATASC', 'AFTER_EXECUTION', 'ESCALATE_TO_HUMAN', '{"role": "Digital biomarker assessment", "focus": "Technical feasibility"}'::jsonb),
    ('TSK-CD-001-P3-01', 'AGT-CLINICAL-ENDPOINT', 'CO_EXECUTOR', 2, false, 2, 'LINEAR', true, NULL, NULL, 'RETRY', '{"role": "Clinical relevance", "focus": "Clinical validation"}'::jsonb),
    
    -- Task 6: Analyze Comparator Landscape (P3-02)
    ('TSK-CD-001-P3-02', 'AGT-CLINICAL-ENDPOINT', 'PRIMARY_EXECUTOR', 1, true, 2, 'EXPONENTIAL_BACKOFF', false, 'P02_VPCLIN', 'AFTER_EXECUTION', 'ESCALATE_TO_HUMAN', '{"role": "Comparator analysis", "focus": "Clinical context"}'::jsonb),
    ('TSK-CD-001-P3-02', 'AGT-LITERATURE-SEARCH', 'CO_EXECUTOR', 2, false, 2, 'LINEAR', true, NULL, NULL, 'RETRY', '{"role": "Market comparators", "focus": "Payer perspective"}'::jsonb),
    
    -- Task 7: Score & Rank Candidate Endpoints (P4-01)
    ('TSK-CD-001-P4-01', 'AGT-DECISION-SYNTHESIZER', 'PRIMARY_EXECUTOR', 1, true, 3, 'EXPONENTIAL_BACKOFF', false, 'P01_CMO', 'AFTER_EXECUTION', 'ESCALATE_TO_HUMAN', '{"role": "Lead endpoint scoring", "focus": "Multi-criteria analysis"}'::jsonb),
    ('TSK-CD-001-P4-01', 'AGT-REGULATORY-STRATEGY', 'CO_EXECUTOR', 2, false, 2, 'LINEAR', true, NULL, NULL, 'RETRY', '{"role": "Regulatory scoring", "focus": "FDA acceptability"}'::jsonb),
    ('TSK-CD-001-P4-01', 'AGT-QUALITY-VALIDATOR', 'VALIDATOR', 3, false, 2, 'LINEAR', false, NULL, NULL, 'RETRY', '{"role": "Validate scoring", "focus": "Methodology QA"}'::jsonb),
    
    -- Task 8: Power & Sample Size Analysis (P4-02)
    ('TSK-CD-001-P4-02', 'AGT-BIOSTATISTICS', 'PRIMARY_EXECUTOR', 1, true, 3, 'EXPONENTIAL_BACKOFF', false, 'P04_BIOSTAT', 'AFTER_EXECUTION', 'ESCALATE_TO_HUMAN', '{"role": "Power analysis", "focus": "Sample size calculation"}'::jsonb),
    
    -- Task 9: Draft Endpoint Justification (P4-03)
    ('TSK-CD-001-P4-03', 'AGT-CLINICAL-REPORT-WRITER', 'PRIMARY_EXECUTOR', 1, true, 2, 'EXPONENTIAL_BACKOFF', false, 'P04_REGDIR', 'AFTER_EXECUTION', 'ESCALATE_TO_HUMAN', '{"role": "Draft regulatory justification", "focus": "FDA submission quality"}'::jsonb),
    ('TSK-CD-001-P4-03', 'AGT-REGULATORY-STRATEGY', 'CO_EXECUTOR', 2, false, 2, 'LINEAR', true, NULL, NULL, 'RETRY', '{"role": "Regulatory strategy", "focus": "FDA precedent alignment"}'::jsonb),
    
    -- Task 10: Design Measurement Schedule (P5-01)
    ('TSK-CD-001-P5-01', 'AGT-PROTOCOL-DESIGNER', 'PRIMARY_EXECUTOR', 1, true, 2, 'EXPONENTIAL_BACKOFF', false, 'P02_VPCLIN', 'AFTER_EXECUTION', 'ESCALATE_TO_HUMAN', '{"role": "Measurement schedule design", "focus": "Operational feasibility"}'::jsonb),
    ('TSK-CD-001-P5-01', 'AGT-BIOSTATISTICS', 'CO_EXECUTOR', 2, false, 2, 'LINEAR', true, NULL, NULL, 'RETRY', '{"role": "Data collection strategy", "focus": "Digital integration"}'::jsonb),
    
    -- Task 11: Plan Validation Strategy (P5-02)
    ('TSK-CD-001-P5-02', 'AGT-CLINICAL-ENDPOINT', 'PRIMARY_EXECUTOR', 1, true, 3, 'EXPONENTIAL_BACKOFF', false, 'P08_CLINRES', 'AFTER_EXECUTION', 'ESCALATE_TO_HUMAN', '{"role": "Validation planning", "focus": "Psychometric strategy"}'::jsonb),
    ('TSK-CD-001-P5-02', 'AGT-REGULATORY-STRATEGY', 'CO_EXECUTOR', 2, false, 2, 'LINEAR', true, NULL, NULL, 'RETRY', '{"role": "Regulatory validation requirements", "focus": "FDA expectations"}'::jsonb),
    
    -- Task 12: Assess Risk & Mitigation (P5-03)
    ('TSK-CD-001-P5-03', 'AGT-REGULATORY-COMPLIANCE', 'PRIMARY_EXECUTOR', 1, true, 3, 'EXPONENTIAL_BACKOFF', false, 'P04_REGDIR', 'AFTER_EXECUTION', 'ESCALATE_TO_HUMAN', '{"role": "Risk assessment lead", "focus": "FDA concerns mitigation"}'::jsonb),
    ('TSK-CD-001-P5-03', 'AGT-QUALITY-VALIDATOR', 'CO_EXECUTOR', 2, false, 2, 'LINEAR', true, NULL, NULL, 'RETRY', '{"role": "Risk validation", "focus": "Completeness check"}'::jsonb),
    
    -- Task 13: Compile Final Recommendation (P5-04)
    ('TSK-CD-001-P5-04', 'AGT-EVIDENCE-SYNTHESIZER', 'PRIMARY_EXECUTOR', 1, true, 3, 'EXPONENTIAL_BACKOFF', false, 'P01_CMO', 'AFTER_EXECUTION', 'ESCALATE_TO_HUMAN', '{"role": "Compile final report", "focus": "Executive summary + detailed analysis"}'::jsonb),
    ('TSK-CD-001-P5-04', 'AGT-QUALITY-VALIDATOR', 'VALIDATOR', 2, false, 2, 'LINEAR', false, NULL, NULL, 'RETRY', '{"role": "Final QA", "focus": "Completeness and accuracy"}'::jsonb)
) AS agent_data(
  task_code,
  agent_code,
  assignment_type,
  execution_order,
  requires_human_approval,
  max_retries,
  retry_strategy,
  is_parallel,
  approval_persona_code,
  approval_stage,
  on_failure,
  metadata
)
INNER JOIN dh_task t ON t.code = agent_data.task_code AND t.tenant_id = sc.tenant_id
INNER JOIN dh_agent a ON a.code = agent_data.agent_code AND a.tenant_id = sc.tenant_id
ON CONFLICT (tenant_id, task_id, agent_id, assignment_type)
DO UPDATE SET
  execution_order = EXCLUDED.execution_order,
  requires_human_approval = EXCLUDED.requires_human_approval,
  metadata = EXCLUDED.metadata;

-- =====================================================================================
-- SECTION 3: TASK-PERSONA ASSIGNMENTS
-- =====================================================================================
-- Assign human personas for review, approval, and input

INSERT INTO dh_task_persona (
  tenant_id,
  task_id,
  persona_id,
  responsibility,
  is_blocking,
  review_timing,
  notification_method,
  metadata
)
SELECT 
  sc.tenant_id,
  t.id as task_id,
  p.id as persona_id,
  persona_data.responsibility,
  persona_data.is_blocking,
  persona_data.review_timing,
  persona_data.notification_method,
  persona_data.metadata
FROM session_config sc
CROSS JOIN (
  VALUES
    -- Task 1: Define Clinical Context (P1-01)
    ('TSK-CD-001-P1-01', 'P01_CMO', 'APPROVE', true, 'AFTER_AGENT_RUNS', 'email', '{"role": "Final approval", "review_focus": "Clinical accuracy and strategic alignment", "is_decision_maker": true}'::jsonb),
    ('TSK-CD-001-P1-01', 'P02_VPCLIN', 'REVIEW', false, 'PARALLEL', 'email', '{"role": "Clinical development review", "review_focus": "Operational feasibility"}'::jsonb),
    ('TSK-CD-001-P1-01', 'P04_REGDIR', 'PROVIDE_INPUT', false, 'PARALLEL', 'email', '{"role": "Regulatory input", "review_focus": "FDA perspective"}'::jsonb),
    
    -- Task 2: Identify Patient-Centered Outcomes (P1-02)
    ('TSK-CD-001-P1-02', 'P10_PATADV', 'APPROVE', true, 'AFTER_AGENT_RUNS', 'email', '{"role": "Patient advocacy approval", "review_focus": "Patient relevance and impact"}'::jsonb),
    ('TSK-CD-001-P1-02', 'P01_CMO', 'REVIEW', false, 'AFTER_AGENT_RUNS', 'email', '{"role": "Clinical review", "review_focus": "Clinical meaningfulness"}'::jsonb),
    ('TSK-CD-001-P1-02', 'P15_HEOR', 'PROVIDE_INPUT', false, 'PARALLEL', 'email', '{"role": "HEOR perspective", "review_focus": "Payer value"}'::jsonb),
    
    -- Task 3: Research Regulatory Precedent (P2-01)
    ('TSK-CD-001-P2-01', 'P04_REGDIR', 'APPROVE', true, 'AFTER_AGENT_RUNS', 'email', '{"role": "Regulatory approval", "review_focus": "Precedent accuracy and completeness"}'::jsonb),
    ('TSK-CD-001-P2-01', 'P02_VPCLIN', 'REVIEW', false, 'PARALLEL', 'email', '{"role": "Clinical development review", "review_focus": "Applicability to our product"}'::jsonb),
    ('TSK-CD-001-P2-01', 'P01_CMO', 'REVIEW', false, 'AFTER_AGENT_RUNS', 'email', '{"role": "Strategic review", "review_focus": "Regulatory strategy alignment"}'::jsonb),
    
    -- Task 4: Evaluate PRO Instruments (P2-02)
    ('TSK-CD-001-P2-02', 'P02_VPCLIN', 'APPROVE', true, 'AFTER_AGENT_RUNS', 'email', '{"role": "Clinical development approval", "review_focus": "PRO validation and feasibility"}'::jsonb),
    ('TSK-CD-001-P2-02', 'P04_BIOSTAT', 'REVIEW', false, 'PARALLEL', 'email', '{"role": "Biostatistics review", "review_focus": "Psychometric properties"}'::jsonb),
    ('TSK-CD-001-P2-02', 'P10_PATADV', 'PROVIDE_INPUT', false, 'PARALLEL', 'email', '{"role": "Patient burden assessment", "review_focus": "Patient acceptability"}'::jsonb),
    
    -- Task 5: Assess Digital Biomarker Feasibility (P3-01)
    ('TSK-CD-001-P3-01', 'P07_DATASC', 'APPROVE', true, 'AFTER_AGENT_RUNS', 'email', '{"role": "Data science approval", "review_focus": "Technical feasibility and validation"}'::jsonb),
    ('TSK-CD-001-P3-01', 'P01_CMO', 'REVIEW', false, 'AFTER_AGENT_RUNS', 'email', '{"role": "Clinical review", "review_focus": "Clinical relevance"}'::jsonb),
    ('TSK-CD-001-P3-01', 'P04_REGDIR', 'REVIEW', false, 'PARALLEL', 'email', '{"role": "Regulatory review", "review_focus": "FDA acceptance likelihood"}'::jsonb),
    
    -- Task 6: Analyze Comparator Landscape (P3-02)
    ('TSK-CD-001-P3-02', 'P02_VPCLIN', 'APPROVE', true, 'AFTER_AGENT_RUNS', 'email', '{"role": "Clinical development approval", "review_focus": "Comparator selection"}'::jsonb),
    ('TSK-CD-001-P3-02', 'P15_HEOR', 'REVIEW', false, 'PARALLEL', 'email', '{"role": "HEOR review", "review_focus": "Payer perspective and comparator relevance"}'::jsonb),
    ('TSK-CD-001-P3-02', 'P01_CMO', 'REVIEW', false, 'AFTER_AGENT_RUNS', 'email', '{"role": "Strategic review", "review_focus": "Competitive positioning"}'::jsonb),
    
    -- Task 7: Score & Rank Candidate Endpoints (P4-01)
    ('TSK-CD-001-P4-01', 'P01_CMO', 'APPROVE', true, 'AFTER_AGENT_RUNS', 'email', '{"role": "Final endpoint approval", "review_focus": "Strategic fit and risk assessment"}'::jsonb),
    ('TSK-CD-001-P4-01', 'P04_REGDIR', 'REVIEW', false, 'PARALLEL', 'email', '{"role": "Regulatory review", "review_focus": "FDA acceptability scoring"}'::jsonb),
    ('TSK-CD-001-P4-01', 'P02_VPCLIN', 'REVIEW', false, 'PARALLEL', 'email', '{"role": "Operational review", "review_focus": "Feasibility scoring"}'::jsonb),
    ('TSK-CD-001-P4-01', 'P04_BIOSTAT', 'PROVIDE_INPUT', false, 'PARALLEL', 'email', '{"role": "Statistical input", "review_focus": "Statistical properties scoring"}'::jsonb),
    
    -- Task 8: Power & Sample Size Analysis (P4-02)
    ('TSK-CD-001-P4-02', 'P04_BIOSTAT', 'APPROVE', true, 'AFTER_AGENT_RUNS', 'email', '{"role": "Biostatistics approval", "review_focus": "Power calculations and assumptions"}'::jsonb),
    ('TSK-CD-001-P4-02', 'P02_VPCLIN', 'REVIEW', false, 'AFTER_AGENT_RUNS', 'email', '{"role": "Clinical development review", "review_focus": "Feasibility and recruitment"}'::jsonb),
    ('TSK-CD-001-P4-02', 'P01_CMO', 'REVIEW', false, 'AFTER_AGENT_RUNS', 'email', '{"role": "Strategic review", "review_focus": "Resource implications"}'::jsonb),
    
    -- Task 9: Draft Endpoint Justification (P4-03)
    ('TSK-CD-001-P4-03', 'P04_REGDIR', 'APPROVE', true, 'AFTER_AGENT_RUNS', 'email', '{"role": "Regulatory approval", "review_focus": "FDA submission readiness"}'::jsonb),
    ('TSK-CD-001-P4-03', 'P01_CMO', 'REVIEW', false, 'AFTER_AGENT_RUNS', 'email', '{"role": "Medical review", "review_focus": "Clinical and scientific rigor"}'::jsonb),
    ('TSK-CD-001-P4-03', 'P16_MEDWRIT', 'PROVIDE_INPUT', false, 'PARALLEL', 'email', '{"role": "Medical writing", "review_focus": "Document quality and clarity"}'::jsonb),
    
    -- Task 10: Design Measurement Schedule (P5-01)
    ('TSK-CD-001-P5-01', 'P02_VPCLIN', 'APPROVE', true, 'AFTER_AGENT_RUNS', 'email', '{"role": "Clinical operations approval", "review_focus": "Operational feasibility"}'::jsonb),
    ('TSK-CD-001-P5-01', 'P10_PATADV', 'REVIEW', false, 'PARALLEL', 'email', '{"role": "Patient burden review", "review_focus": "Patient acceptability"}'::jsonb),
    ('TSK-CD-001-P5-01', 'P07_DATASC', 'PROVIDE_INPUT', false, 'PARALLEL', 'email', '{"role": "Data collection input", "review_focus": "Digital integration"}'::jsonb),
    
    -- Task 11: Plan Validation Strategy (P5-02)
    ('TSK-CD-001-P5-02', 'P08_CLINRES', 'APPROVE', true, 'AFTER_AGENT_RUNS', 'email', '{"role": "Clinical research approval", "review_focus": "Validation methodology"}'::jsonb),
    ('TSK-CD-001-P5-02', 'P04_REGDIR', 'REVIEW', false, 'PARALLEL', 'email', '{"role": "Regulatory review", "review_focus": "FDA validation expectations"}'::jsonb),
    ('TSK-CD-001-P5-02', 'P02_VPCLIN', 'REVIEW', false, 'AFTER_AGENT_RUNS', 'email', '{"role": "Clinical development review", "review_focus": "Timeline and resources"}'::jsonb),
    
    -- Task 12: Assess Risk & Mitigation (P5-03)
    ('TSK-CD-001-P5-03', 'P04_REGDIR', 'APPROVE', true, 'AFTER_AGENT_RUNS', 'email', '{"role": "Regulatory risk approval", "review_focus": "Mitigation completeness"}'::jsonb),
    ('TSK-CD-001-P5-03', 'P01_CMO', 'REVIEW', false, 'AFTER_AGENT_RUNS', 'email', '{"role": "Strategic risk review", "review_focus": "Overall risk acceptability"}'::jsonb),
    ('TSK-CD-001-P5-03', 'P02_VPCLIN', 'PROVIDE_INPUT', false, 'PARALLEL', 'email', '{"role": "Operational risk input", "review_focus": "Execution risks"}'::jsonb),
    
    -- Task 13: Compile Final Recommendation (P5-04)
    ('TSK-CD-001-P5-04', 'P01_CMO', 'APPROVE', true, 'AFTER_AGENT_RUNS', 'email', '{"role": "Final CMO approval", "review_focus": "Strategic alignment and executive readiness"}'::jsonb),
    ('TSK-CD-001-P5-04', 'P04_REGDIR', 'REVIEW', false, 'AFTER_AGENT_RUNS', 'email', '{"role": "Regulatory final review", "review_focus": "Regulatory strategy coherence"}'::jsonb),
    ('TSK-CD-001-P5-04', 'P02_VPCLIN', 'REVIEW', false, 'AFTER_AGENT_RUNS', 'email', '{"role": "Clinical development final review", "review_focus": "Implementation plan"}'::jsonb),
    ('TSK-CD-001-P5-04', 'P16_MEDWRIT', 'PROVIDE_INPUT', false, 'PARALLEL', 'email', '{"role": "Final document review", "review_focus": "Quality and completeness"}'::jsonb)
) AS persona_data(
  task_code,
  persona_code,
  responsibility,
  is_blocking,
  review_timing,
  notification_method,
  metadata
)
INNER JOIN dh_task t ON t.code = persona_data.task_code AND t.tenant_id = sc.tenant_id
INNER JOIN dh_persona p ON p.code = persona_data.persona_code AND p.tenant_id = sc.tenant_id
ON CONFLICT (tenant_id, task_id, persona_id, responsibility)
DO UPDATE SET
  is_blocking = EXCLUDED.is_blocking,
  review_timing = EXCLUDED.review_timing,
  metadata = EXCLUDED.metadata;

-- =====================================================================================
-- SECTION 4: TASK-TOOL MAPPINGS
-- =====================================================================================
-- Map tools to tasks for resource access

INSERT INTO dh_task_tool (
  task_id,
  tool_id,
  connection_config
)
SELECT 
  t.id as task_id,
  tool.id as tool_id,
  tool_data.connection_config
FROM session_config sc
CROSS JOIN (
  VALUES
    -- Task 1: Clinical Context (literature search, FDA guidance)
    ('TSK-CD-001-P1-01', 'TOOL-LIT-001', '{"purpose": "Clinical literature search", "search_scope": "Disease epidemiology and burden"}'::jsonb),
    ('TSK-CD-001-P1-01', 'TOOL-FDA-001', '{"purpose": "FDA guidance review", "focus": "Digital health and DTx guidance"}'::jsonb),
    
    -- Task 2: Patient Outcomes (PRO database, patient forums)
    ('TSK-CD-001-P1-02', 'TOOL-PRO-001', '{"purpose": "PRO instrument search", "focus": "Patient-reported outcomes"}'::jsonb),
    
    -- Task 3: Regulatory Precedent (FDA database, regulatory intelligence)
    ('TSK-CD-001-P2-01', 'TOOL-FDA-001', '{"purpose": "FDA precedent analysis", "focus": "Prior DTx approvals"}'::jsonb),
    ('TSK-CD-001-P2-01', 'TOOL-LIT-001', '{"purpose": "Regulatory literature", "focus": "Endpoint precedent"}'::jsonb),
    ('TSK-CD-001-P2-01', 'TOOL-REG-001', '{"purpose": "Regulatory intelligence", "focus": "FDA decisions and feedback"}'::jsonb),
    
    -- Task 4: PRO Evaluation (PRO database, validation tools)
    ('TSK-CD-001-P2-02', 'TOOL-PRO-001', '{"purpose": "PRO instrument evaluation", "focus": "Psychometric properties"}'::jsonb),
    ('TSK-CD-001-P2-02', 'TOOL-LIT-001', '{"purpose": "PRO validation literature", "focus": "Validation studies"}'::jsonb),
    
    -- Task 5: Digital Biomarkers (wearable data, digital health platforms)
    ('TSK-CD-001-P3-01', 'TOOL-DATA-001', '{"purpose": "Digital biomarker analysis", "focus": "Sensor data capabilities"}'::jsonb),
    ('TSK-CD-001-P3-01', 'TOOL-LIT-001', '{"purpose": "Digital biomarker literature", "focus": "Validation evidence"}'::jsonb),
    
    -- Task 6: Comparator Analysis (market research, competitive intelligence)
    ('TSK-CD-001-P3-02', 'TOOL-LIT-001', '{"purpose": "Comparator research", "focus": "Standard of care and competitors"}'::jsonb),
    
    -- Task 7: Endpoint Scoring (decision matrix tools)
    ('TSK-CD-001-P4-01', 'TOOL-DATA-001', '{"purpose": "Multi-criteria analysis", "focus": "Endpoint scoring and ranking"}'::jsonb),
    
    -- Task 8: Power Analysis (statistical software)
    ('TSK-CD-001-P4-02', 'TOOL-DATA-001', '{"purpose": "Power calculations", "focus": "Sample size estimation"}'::jsonb),
    
    -- Task 9: Endpoint Justification (medical writing tools)
    ('TSK-CD-001-P4-03', 'TOOL-FDA-001', '{"purpose": "Regulatory templates", "focus": "FDA submission format"}'::jsonb),
    
    -- Task 10: Measurement Schedule (clinical trial design tools)
    ('TSK-CD-001-P5-01', 'TOOL-DATA-001', '{"purpose": "Schedule optimization", "focus": "Visit timing and burden analysis"}'::jsonb),
    
    -- Task 11: Validation Strategy (validation frameworks)
    ('TSK-CD-001-P5-02', 'TOOL-PRO-001', '{"purpose": "Validation planning", "focus": "Psychometric validation methodology"}'::jsonb),
    ('TSK-CD-001-P5-02', 'TOOL-FDA-001', '{"purpose": "FDA validation guidance", "focus": "Regulatory requirements"}'::jsonb),
    
    -- Task 12: Risk Assessment (risk management tools)
    ('TSK-CD-001-P5-03', 'TOOL-FDA-001', '{"purpose": "Regulatory risk assessment", "focus": "FDA concerns identification"}'::jsonb),
    
    -- Task 13: Final Recommendation (document compilation)
    ('TSK-CD-001-P5-04', 'TOOL-DATA-001', '{"purpose": "Report generation", "focus": "Data visualization and synthesis"}'::jsonb)
) AS tool_data(task_code, tool_code, connection_config)
INNER JOIN dh_task t ON t.code = tool_data.task_code AND t.tenant_id = sc.tenant_id
INNER JOIN dh_tool tool ON tool.code = tool_data.tool_code AND tool.tenant_id = sc.tenant_id
ON CONFLICT (task_id, tool_id)
DO UPDATE SET
  connection_config = EXCLUDED.connection_config;

-- =====================================================================================
-- SECTION 5: TASK-RAG SOURCE MAPPINGS
-- =====================================================================================
-- Map RAG knowledge sources to tasks

INSERT INTO dh_task_rag (
  task_id,
  rag_source_id,
  query_context,
  is_required,
  search_config
)
SELECT 
  t.id as task_id,
  rag.id as rag_source_id,
  rag_data.query_context,
  rag_data.is_required,
  rag_data.search_config
FROM session_config sc
CROSS JOIN (
  VALUES
    -- Task 1: Clinical Context
    ('TSK-CD-001-P1-01', 'RAG-FDA-GUIDE', 'What are FDA guidance documents for digital therapeutics and clinical endpoints?', true, '{"purpose": "FDA regulatory guidance", "focus": "DTx endpoint selection", "max_results": 10}'::jsonb),
    ('TSK-CD-001-P1-01', 'RAG-CLIN-LIT', 'What is the clinical burden and epidemiology of [indication]?', true, '{"purpose": "Clinical context", "focus": "Disease burden", "max_results": 20}'::jsonb),
    
    -- Task 2: Patient Outcomes
    ('TSK-CD-001-P1-02', 'RAG-PRO-DB', 'What patient-reported outcomes are relevant for [indication]?', true, '{"purpose": "PRO identification", "focus": "Patient-centered outcomes", "max_results": 15}'::jsonb),
    ('TSK-CD-001-P1-02', 'RAG-CLIN-LIT', 'What outcomes matter most to patients with [indication]?', true, '{"purpose": "Patient priorities", "focus": "Quality of life", "max_results": 15}'::jsonb),
    
    -- Task 3: Regulatory Precedent
    ('TSK-CD-001-P2-01', 'RAG-FDA-APRV', 'What DTx products have been approved for [indication] and what endpoints were used?', true, '{"purpose": "Regulatory precedent", "focus": "FDA-accepted endpoints", "max_results": 20}'::jsonb),
    ('TSK-CD-001-P2-01', 'RAG-FDA-GUIDE', 'What are FDA requirements for clinical endpoints in [indication]?', true, '{"purpose": "FDA requirements", "focus": "Endpoint standards", "max_results": 10}'::jsonb),
    
    -- Task 4: PRO Evaluation
    ('TSK-CD-001-P2-02', 'RAG-PRO-DB', 'What are validated PRO instruments for [indication] and their psychometric properties?', true, '{"purpose": "PRO validation evidence", "focus": "Psychometric properties", "max_results": 25}'::jsonb),
    ('TSK-CD-001-P2-02', 'RAG-CLIN-LIT', 'What is the validation evidence for PRO instruments in [indication]?', true, '{"purpose": "PRO validation studies", "focus": "Responsiveness and MCID", "max_results": 20}'::jsonb),
    
    -- Task 5: Digital Biomarkers
    ('TSK-CD-001-P3-01', 'RAG-DIGI-BIO', 'What digital biomarkers exist for [indication] and what is their validation status?', true, '{"purpose": "Digital biomarker landscape", "focus": "Validation evidence", "max_results": 20}'::jsonb),
    ('TSK-CD-001-P3-01', 'RAG-FDA-APRV', 'Has FDA accepted any digital biomarkers for [indication]?', true, '{"purpose": "FDA precedent", "focus": "Digital measure acceptance", "max_results": 10}'::jsonb),
    
    -- Task 6: Comparator Analysis
    ('TSK-CD-001-P3-02', 'RAG-CLIN-LIT', 'What are standard of care treatments for [indication] and their endpoints?', true, '{"purpose": "Comparator identification", "focus": "Current treatment standards", "max_results": 15}'::jsonb),
    ('TSK-CD-001-P3-02', 'RAG-HEOR-DATA', 'What outcomes do payers use for [indication] coverage decisions?', true, '{"purpose": "Payer perspective", "focus": "Reimbursement criteria", "max_results": 10}'::jsonb),
    
    -- Task 7: Endpoint Scoring
    ('TSK-CD-001-P4-01', 'RAG-FDA-APRV', 'Which endpoints have the strongest FDA precedent for DTx?', true, '{"purpose": "Regulatory scoring", "focus": "FDA acceptance history", "max_results": 15}'::jsonb),
    ('TSK-CD-001-P4-01', 'RAG-PRO-DB', 'What are the psychometric properties of candidate endpoints?', true, '{"purpose": "Psychometric scoring", "focus": "Validation strength", "max_results": 20}'::jsonb),
    
    -- Task 8: Power Analysis
    ('TSK-CD-001-P4-02', 'RAG-CLIN-LIT', 'What are typical effect sizes and variability for [endpoint] in [indication]?', true, '{"purpose": "Power calculation inputs", "focus": "Effect sizes and SDs", "max_results": 20}'::jsonb),
    
    -- Task 9: Endpoint Justification
    ('TSK-CD-001-P4-03', 'RAG-FDA-APRV', 'What was the FDA rationale for accepting similar endpoints?', true, '{"purpose": "Regulatory justification", "focus": "FDA precedent reasoning", "max_results": 15}'::jsonb),
    ('TSK-CD-001-P4-03', 'RAG-FDA-GUIDE', 'What are FDA expectations for endpoint justification?', true, '{"purpose": "FDA requirements", "focus": "Justification standards", "max_results": 10}'::jsonb),
    
    -- Task 10: Measurement Schedule
    ('TSK-CD-001-P5-01', 'RAG-CLIN-LIT', 'What measurement schedules are used in [indication] trials?', true, '{"purpose": "Schedule precedent", "focus": "Assessment timing", "max_results": 15}'::jsonb),
    
    -- Task 11: Validation Strategy
    ('TSK-CD-001-P5-02', 'RAG-PRO-DB', 'What validation methodology is recommended for [endpoint type]?', true, '{"purpose": "Validation guidance", "focus": "Psychometric methods", "max_results": 10}'::jsonb),
    ('TSK-CD-001-P5-02', 'RAG-FDA-GUIDE', 'What are FDA validation requirements for novel endpoints?', true, '{"purpose": "FDA validation standards", "focus": "Regulatory requirements", "max_results": 10}'::jsonb),
    
    -- Task 12: Risk Assessment
    ('TSK-CD-001-P5-03', 'RAG-FDA-GUIDE', 'What are common FDA concerns for DTx endpoints?', true, '{"purpose": "Risk identification", "focus": "FDA objections", "max_results": 10}'::jsonb),
    ('TSK-CD-001-P5-03', 'RAG-FDA-APRV', 'What FDA questions and concerns were raised for similar DTx products?', true, '{"purpose": "Precedent concerns", "focus": "FDA feedback", "max_results": 15}'::jsonb),
    
    -- Task 13: Final Recommendation
    ('TSK-CD-001-P5-04', 'RAG-FDA-GUIDE', 'What is the complete FDA framework for endpoint selection?', true, '{"purpose": "Comprehensive guidance", "focus": "End-to-end requirements", "max_results": 10}'::jsonb)
) AS rag_data(task_code, rag_code, query_context, is_required, search_config)
INNER JOIN dh_task t ON t.code = rag_data.task_code AND t.tenant_id = sc.tenant_id
INNER JOIN dh_rag_source rag ON rag.code = rag_data.rag_code AND rag.tenant_id = sc.tenant_id
ON CONFLICT (task_id, rag_source_id)
DO UPDATE SET
  query_context = EXCLUDED.query_context,
  search_config = EXCLUDED.search_config;

-- =====================================================================================
-- SECTION 6: VERIFICATION QUERIES
-- =====================================================================================

-- Verify task dependencies
SELECT 
  'UC-01 Task Dependencies' as status,
  COUNT(*) as dependency_count
FROM dh_task_dependency td
INNER JOIN dh_task t ON t.id = td.task_id
WHERE t.code LIKE 'TSK-CD-001-%';

-- Verify agent assignments
SELECT 
  'UC-01 Task-Agent Assignments' as status,
  COUNT(*) as assignment_count
FROM dh_task_agent ta
INNER JOIN dh_task t ON t.id = ta.task_id
WHERE t.code LIKE 'TSK-CD-001-%';

-- Verify persona assignments
SELECT 
  'UC-01 Task-Persona Assignments' as status,
  COUNT(*) as assignment_count
FROM dh_task_persona tp
INNER JOIN dh_task t ON t.id = tp.task_id
WHERE t.code LIKE 'TSK-CD-001-%';

-- Verify tool mappings
SELECT 
  'UC-01 Task-Tool Mappings' as status,
  COUNT(*) as mapping_count
FROM dh_task_tool tt
INNER JOIN dh_task t ON t.id = tt.task_id
WHERE t.code LIKE 'TSK-CD-001-%';

-- Verify RAG mappings
SELECT 
  'UC-01 Task-RAG Mappings' as status,
  COUNT(*) as mapping_count
FROM dh_task_rag tr
INNER JOIN dh_task t ON t.id = tr.task_id
WHERE t.code LIKE 'TSK-CD-001-%';

-- Summary
SELECT 
  'UC-01 Assignments Complete' as status,
  (SELECT COUNT(*) FROM dh_task WHERE code LIKE 'TSK-CD-001-%') as total_tasks,
  (SELECT COUNT(*) FROM dh_task_dependency td INNER JOIN dh_task t ON t.id = td.task_id WHERE t.code LIKE 'TSK-CD-001-%') as dependencies,
  (SELECT COUNT(*) FROM dh_task_agent ta INNER JOIN dh_task t ON t.id = ta.task_id WHERE t.code LIKE 'TSK-CD-001-%') as agent_assignments,
  (SELECT COUNT(*) FROM dh_task_persona tp INNER JOIN dh_task t ON t.id = tp.task_id WHERE t.code LIKE 'TSK-CD-001-%') as persona_assignments,
  (SELECT COUNT(*) FROM dh_task_tool tt INNER JOIN dh_task t ON t.id = tt.task_id WHERE t.code LIKE 'TSK-CD-001-%') as tool_mappings,
  (SELECT COUNT(*) FROM dh_task_rag tr INNER JOIN dh_task t ON t.id = tr.task_id WHERE t.code LIKE 'TSK-CD-001-%') as rag_mappings;

-- =====================================================================================
-- END OF UC-01 PART 2 SEED FILE
-- =====================================================================================

