%%{init: {'theme':'base', 'themeVariables': { 'primaryColor': '#4f46e5', 'primaryTextColor': '#ffffff', 'primaryBorderColor': '#3730a3', 'lineColor': '#6b7280', 'secondaryColor': '#f3f4f6', 'tertiaryColor': '#e5e7eb'}}}%%

graph TB
    subgraph "VITAL Path Platform - C4 Architecture"

        %% Context Level - External Actors
        subgraph "External Context"
            Clinicians[👨‍⚕️ Clinicians<br/>Medical professionals using AI tools]
            Researchers[🔬 Researchers<br/>Clinical research and drug development]
            Regulators[🏛️ Regulators<br/>FDA, EMA compliance oversight]
            Patients[👥 Patients<br/>End users of digital therapeutics]

            EHR[🏥 EHR Systems<br/>Epic, Cerner, Allscripts]
            PubMed[📚 PubMed/MEDLINE<br/>Medical literature database]
            FDA_DB[📋 FDA Databases<br/>Orange Book, Clinical Trials]
            LLM_Providers[🤖 LLM Providers<br/>OpenAI, Anthropic, Medical Models]
        end

        %% Container Level - Major System Components
        subgraph "VITAL Path Platform"

            %% Frontend Container
            subgraph "Frontend Layer"
                WebApp[🌐 Next.js Web Application<br/>TypeScript SPA with SSR<br/>25+ routes, 100+ components<br/>Clinical UI with HIPAA compliance]

                WebApp_Features["🔹 Authentication & Authorization<br/>🔹 Clinical Workflow Builder<br/>🔹 Medical Query Interface<br/>🔹 Agent Management<br/>🔹 Knowledge Base UI<br/>🔹 Real-time Chat<br/>🔹 Analytics Dashboards"]
            end

            %% API Gateway Container
            subgraph "API Gateway Layer"
                APIGateway[⚡ Next.js API Routes<br/>80+ REST endpoints<br/>Authentication & Rate Limiting<br/>Request routing & validation]

                APIGateway_Features["🔹 Session Management<br/>🔹 Role-based Access Control<br/>🔹 API Rate Limiting<br/>🔹 Request Validation<br/>🔹 Error Handling<br/>🔹 Audit Logging"]
            end

            %% Core Services Container
            subgraph "Core Application Services"
                AgentOrchestrator[🎯 Agent Orchestrator<br/>Master orchestrator for agent routing<br/>Triage classification<br/>Workflow management]

                ChatService[💬 Chat Service<br/>Real-time medical chat<br/>Agent selection & routing<br/>Clinical validation integration]

                KnowledgeService[📖 Knowledge Management<br/>Document upload & processing<br/>Vector search & RAG<br/>Citation tracking]

                ClinicalValidator[⚗️ Clinical Validation<br/>PHARMA & VERIFY frameworks<br/>Medical accuracy checking<br/>Safety monitoring]
            end

            %% AI/ML Services Container (Python)
            subgraph "Phase 5 AI/ML Services (Python FastAPI)"
                ClinicalAI[🧠 Clinical AI Optimizer<br/>Model optimization & fine-tuning<br/>PHARMA validation framework<br/>Medical accuracy >98%]

                GlobalScaling[🌍 Healthcare Scaling<br/>Multi-jurisdiction deployment<br/>FDA, EMA, MHRA compliance<br/>Data sovereignty]

                EcosystemIntegration[🔗 Healthcare Integrations<br/>EHR system connectivity<br/>HL7 FHIR standards<br/>Medical device integration]

                ClinicalIntelligence[📊 Clinical Intelligence<br/>Predictive analytics<br/>Population health insights<br/>Real-time monitoring]

                MedicalLearning[🎓 Medical Learning<br/>Continuous knowledge evolution<br/>Evidence synthesis<br/>Expert validation networks]
            end

            %% Background Processing
            subgraph "Background Processing"
                JobQueues[⚙️ Redis Job Queues<br/>Medical processing queue<br/>Clinical validation queue<br/>Agent orchestration queue<br/>Knowledge indexing queue]

                Schedulers[⏰ Background Schedulers<br/>Medical knowledge sync (daily)<br/>Compliance audit (weekly)<br/>Model evaluation (hourly)]
            end

            %% Data Layer
            subgraph "Data Storage Layer"
                PostgreSQL[(🐘 PostgreSQL 15+<br/>Multi-tenant with RLS<br/>Medical, Regulatory schemas<br/>Audit logging, Encryption)]

                pgVector[(🔍 pgvector Extension<br/>3072-dim embeddings<br/>Medical document vectors<br/>Semantic search)]

                Redis[(🔴 Redis Cache<br/>Sessions, Rate limiting<br/>Real-time chat<br/>Clinical alerts<br/>Job queues)]

                ObjectStorage[(📁 Object Storage<br/>Medical documents<br/>Clinical images<br/>HIPAA compliant<br/>Encryption at rest)]
            end
        end

        %% Security & Monitoring
        subgraph "Security & Observability"
            Auth[🔐 Supabase Auth<br/>Multi-factor authentication<br/>OAuth integrations<br/>Session management]

            Monitoring[📈 Monitoring Stack<br/>OpenTelemetry tracing<br/>Prometheus metrics<br/>Structured logging<br/>Real-time alerting]

            Compliance[📜 Compliance Framework<br/>HIPAA, FDA 21 CFR Part 11<br/>GDPR, SOC2<br/>Audit trails]
        end
    end

    %% Connections - External to Platform
    Clinicians --> WebApp
    Researchers --> WebApp
    Regulators --> Compliance
    Patients --> WebApp

    %% External System Integrations
    EHR --> EcosystemIntegration
    PubMed --> MedicalLearning
    FDA_DB --> GlobalScaling
    LLM_Providers --> ClinicalAI

    %% Internal Connections - Frontend to API
    WebApp --> APIGateway
    WebApp --> Auth

    %% API Gateway to Core Services
    APIGateway --> AgentOrchestrator
    APIGateway --> ChatService
    APIGateway --> KnowledgeService
    APIGateway --> ClinicalValidator

    %% Core Services to AI/ML Services
    AgentOrchestrator --> ClinicalAI
    ChatService --> ClinicalIntelligence
    KnowledgeService --> MedicalLearning
    ClinicalValidator --> GlobalScaling

    %% AI/ML Services Interconnections
    ClinicalAI --> EcosystemIntegration
    GlobalScaling --> ClinicalIntelligence
    EcosystemIntegration --> MedicalLearning
    ClinicalIntelligence --> MedicalLearning

    %% Background Processing
    AgentOrchestrator --> JobQueues
    KnowledgeService --> JobQueues
    ClinicalValidator --> JobQueues
    JobQueues --> Schedulers

    %% Data Layer Connections
    APIGateway --> PostgreSQL
    AgentOrchestrator --> PostgreSQL
    ChatService --> Redis
    KnowledgeService --> pgVector
    ClinicalValidator --> PostgreSQL

    ClinicalAI --> PostgreSQL
    GlobalScaling --> PostgreSQL
    EcosystemIntegration --> PostgreSQL
    ClinicalIntelligence --> PostgreSQL
    MedicalLearning --> pgVector

    JobQueues --> Redis
    Schedulers --> PostgreSQL

    KnowledgeService --> ObjectStorage
    EcosystemIntegration --> ObjectStorage

    %% Security & Monitoring Connections
    APIGateway --> Auth
    WebApp --> Auth
    AgentOrchestrator --> Monitoring
    ClinicalValidator --> Compliance

    %% Styling
    classDef frontend fill:#dbeafe,stroke:#3b82f6,stroke-width:2px,color:#1e40af
    classDef api fill:#fef3c7,stroke:#f59e0b,stroke-width:2px,color:#92400e
    classDef core fill:#d1fae5,stroke:#10b981,stroke-width:2px,color:#065f46
    classDef ai fill:#ede9fe,stroke:#8b5cf6,stroke-width:2px,color:#5b21b6
    classDef data fill:#fee2e2,stroke:#ef4444,stroke-width:2px,color:#991b1b
    classDef security fill:#f3f4f6,stroke:#6b7280,stroke-width:2px,color:#374151
    classDef external fill:#fef7ed,stroke:#ea580c,stroke-width:2px,color:#9a3412

    class WebApp,WebApp_Features frontend
    class APIGateway,APIGateway_Features api
    class AgentOrchestrator,ChatService,KnowledgeService,ClinicalValidator core
    class ClinicalAI,GlobalScaling,EcosystemIntegration,ClinicalIntelligence,MedicalLearning ai
    class PostgreSQL,pgVector,Redis,ObjectStorage,JobQueues,Schedulers data
    class Auth,Monitoring,Compliance security
    class Clinicians,Researchers,Regulators,Patients,EHR,PubMed,FDA_DB,LLM_Providers external