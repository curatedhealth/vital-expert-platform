# Alertmanager Configuration
# Routes alerts to appropriate channels (Slack, PagerDuty, Email)

global:
  resolve_timeout: 5m
  # Slack webhook URL (set via environment variable)
  slack_api_url: '${SLACK_WEBHOOK_URL}'

# Templates for alert notifications
templates:
  - '/etc/alertmanager/*.tmpl'

# Route configuration
route:
  # Default receiver for all alerts
  receiver: 'default'
  
  # Group alerts by these labels
  group_by: ['alertname', 'cluster', 'service']
  
  # Wait time before sending a notification
  group_wait: 10s
  
  # Wait time before sending updates for the same group
  group_interval: 10s
  
  # Wait time before re-sending an alert
  repeat_interval: 12h

  # Route tree for different alert types
  routes:
    # Critical alerts go to PagerDuty immediately
    - match:
        severity: critical
      receiver: 'pagerduty'
      continue: true # Also send to Slack

    # Warning alerts go to Slack
    - match:
        severity: warning
      receiver: 'slack-warnings'

    # Cost alerts go to finance channel
    - match:
        category: cost
      receiver: 'slack-finance'

    # Security alerts go to security channel
    - match:
        category: security
      receiver: 'slack-security'

    # Agent performance alerts
    - match:
        category: agent
      receiver: 'slack-engineering'

    # Database alerts
    - match:
        category: database
      receiver: 'slack-engineering'
      continue: true

    # Info alerts (low priority)
    - match:
        severity: info
      receiver: 'slack-info'
      repeat_interval: 24h

# Inhibition rules (suppress certain alerts when others fire)
inhibit_rules:
  # Suppress warning if critical alert is firing
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']

  # Suppress agent latency if agent is down
  - source_match:
      alertname: 'AgentDown'
    target_match:
      alertname: 'HighAgentLatency'
    equal: ['instance']

# Receivers configuration
receivers:
  # Default receiver (catch-all)
  - name: 'default'
    slack_configs:
      - channel: '#vital-alerts'
        title: 'üö® VITAL Alert'
        text: '{{ range .Alerts }}*{{ .Labels.alertname }}*: {{ .Annotations.description }}{{ end }}'
        send_resolved: true

  # PagerDuty for critical alerts
  - name: 'pagerduty'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_SERVICE_KEY}'
        description: '{{ .GroupLabels.alertname }}: {{ .CommonAnnotations.summary }}'
        severity: '{{ .CommonLabels.severity }}'
        client: 'VITAL Platform'
        client_url: 'https://vital.example.com/admin'

  # Slack - Warnings
  - name: 'slack-warnings'
    slack_configs:
      - channel: '#vital-warnings'
        title: '‚ö†Ô∏è  Warning Alert'
        text: |
          *Alert:* {{ .CommonLabels.alertname }}
          *Severity:* {{ .CommonLabels.severity }}
          *Summary:* {{ .CommonAnnotations.summary }}
          *Description:* {{ .CommonAnnotations.description }}
          {{ range .Alerts }}
          *Instance:* {{ .Labels.instance }}
          {{ end }}
        color: 'warning'
        send_resolved: true

  # Slack - Finance/Cost Alerts
  - name: 'slack-finance'
    slack_configs:
      - channel: '#vital-finance'
        title: 'üí∞ Cost Alert'
        text: |
          *Alert:* {{ .CommonLabels.alertname }}
          *Summary:* {{ .CommonAnnotations.summary }}
          *Description:* {{ .CommonAnnotations.description }}
          *Current Value:* ${{ .CommonAnnotations.value }}
        color: '#ff9900'
        send_resolved: true

  # Slack - Security Alerts
  - name: 'slack-security'
    slack_configs:
      - channel: '#vital-security'
        title: 'üîí Security Alert'
        text: |
          *Alert:* {{ .CommonLabels.alertname }}
          *Severity:* {{ .CommonLabels.severity }}
          *Summary:* {{ .CommonAnnotations.summary }}
          *Description:* {{ .CommonAnnotations.description }}
        color: 'danger'
        send_resolved: true

  # Slack - Engineering/Technical
  - name: 'slack-engineering'
    slack_configs:
      - channel: '#vital-engineering'
        title: 'üîß Technical Alert'
        text: |
          *Alert:* {{ .CommonLabels.alertname }}
          *Category:* {{ .CommonLabels.category }}
          *Summary:* {{ .CommonAnnotations.summary }}
          *Description:* {{ .CommonAnnotations.description }}
        color: '#36a64f'
        send_resolved: true

  # Slack - Info (low priority)
  - name: 'slack-info'
    slack_configs:
      - channel: '#vital-info'
        title: '‚ÑπÔ∏è  Information'
        text: '{{ .CommonAnnotations.summary }}'
        send_resolved: false

# Example environment variables needed:
# export SLACK_WEBHOOK_URL="https://hooks.slack.com/services/YOUR/WEBHOOK/URL"
# export PAGERDUTY_SERVICE_KEY="your-pagerduty-key"
