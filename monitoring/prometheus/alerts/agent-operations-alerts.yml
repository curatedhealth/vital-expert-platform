# Agent Operations Alerting Rules
# Alerts for agent search, selection, and GraphRAG operations

groups:
  - name: agent_search_performance
    interval: 30s
    rules:
      # Agent search latency high
      - alert: AgentSearchLatencyHigh
        expr: |
          histogram_quantile(0.95, 
            rate(agent_search_duration_ms_bucket[5m])
          ) > 1000
        for: 5m
        labels:
          severity: warning
          component: agent_search
          slo: latency
        annotations:
          summary: "Agent search P95 latency exceeds 1s"
          description: "P95 latency is {{ $value | humanize }}ms (target: <1000ms). Operation: {{ $labels.operation }}, Method: {{ $labels.method }}"
          runbook_url: "https://docs.vital-path.com/runbooks/agent-search-latency"

      # Agent search latency critical
      - alert: AgentSearchLatencyCritical
        expr: |
          histogram_quantile(0.99, 
            rate(agent_search_duration_ms_bucket[5m])
          ) > 2000
        for: 2m
        labels:
          severity: critical
          component: agent_search
          slo: latency
        annotations:
          summary: "Agent search P99 latency exceeds 2s"
          description: "P99 latency is {{ $value | humanize }}ms (target: <2000ms). Immediate investigation required."
          runbook_url: "https://docs.vital-path.com/runbooks/agent-search-latency-critical"

      # High error rate
      - alert: AgentSearchErrorRateHigh
        expr: |
          rate(agent_search_errors_total[5m]) / 
          rate(agent_search_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: agent_search
        annotations:
          summary: "Agent search error rate exceeds 10%"
          description: "Error rate is {{ $value | humanizePercentage }}. Operation: {{ $labels.operation }}, Error: {{ $labels.error_type }}"
          runbook_url: "https://docs.vital-path.com/runbooks/agent-search-errors"

  - name: graphrag_operations
    interval: 30s
    rules:
      # GraphRAG fallback rate high
      - alert: GraphRAGFallbackRateHigh
        expr: |
          rate(graphrag_search_fallback_total[5m]) / 
          (rate(graphrag_search_hits_total[5m]) + rate(graphrag_search_fallback_total[5m])) > 0.3
        for: 10m
        labels:
          severity: warning
          component: graphrag
        annotations:
          summary: "GraphRAG fallback rate exceeds 30%"
          description: "Fallback rate is {{ $value | humanizePercentage }}. GraphRAG is failing and falling back to database frequently."
          runbook_url: "https://docs.vital-path.com/runbooks/graphrag-fallback"

      # GraphRAG not working
      - alert: GraphRAGNotWorking
        expr: |
          rate(graphrag_search_hits_total[5m]) == 0 and
          rate(graphrag_search_fallback_total[5m]) > 0
        for: 5m
        labels:
          severity: critical
          component: graphrag
        annotations:
          summary: "GraphRAG not working - all searches falling back"
          description: "GraphRAG search is completely failing. All searches are using database fallback."
          runbook_url: "https://docs.vital-path.com/runbooks/graphrag-down"

  - name: agent_selection
    interval: 30s
    rules:
      # Low confidence agent selection rate
      - alert: AgentSelectionLowConfidence
        expr: |
          rate(agent_selection_total{confidence_level="low"}[5m]) / 
          rate(agent_selection_total[5m]) > 0.5
        for: 10m
        labels:
          severity: warning
          component: agent_selection
        annotations:
          summary: "Low confidence agent selection rate exceeds 50%"
          description: "{{ $value | humanizePercentage }} of agent selections have low confidence. This may indicate poor query-agent matching."
          runbook_url: "https://docs.vital-path.com/runbooks/agent-selection-low-confidence"

      # Agent selection latency high
      - alert: AgentSelectionLatencyHigh
        expr: |
          histogram_quantile(0.95, 
            rate(agent_selection_duration_ms_bucket[5m])
          ) > 500
        for: 5m
        labels:
          severity: warning
          component: agent_selection
          mode: "{{ $labels.mode }}"
        annotations:
          summary: "Agent selection latency high"
          description: "P95 latency is {{ $value | humanize }}ms for mode {{ $labels.mode }}"
          runbook_url: "https://docs.vital-path.com/runbooks/agent-selection-latency"

  - name: mode_execution
    interval: 30s
    rules:
      # Mode 2 execution duration high
      - alert: Mode2ExecutionDurationHigh
        expr: |
          histogram_quantile(0.95, 
            rate(mode2_execution_duration_ms_bucket[5m])
          ) > 5000
        for: 5m
        labels:
          severity: warning
          component: mode2
          slo: latency
        annotations:
          summary: "Mode 2 execution duration exceeds 5s"
          description: "P95 duration is {{ $value | humanize }}ms (target: <5000ms)"
          runbook_url: "https://docs.vital-path.com/runbooks/mode2-latency"

      # Mode 3 execution duration high
      - alert: Mode3ExecutionDurationHigh
        expr: |
          histogram_quantile(0.95, 
            rate(mode3_execution_duration_ms_bucket[5m])
          ) > 30000
        for: 5m
        labels:
          severity: warning
          component: mode3
          slo: latency
        annotations:
          summary: "Mode 3 execution duration exceeds 30s"
          description: "P95 duration is {{ $value | humanize }}ms (target: <30000ms)"
          runbook_url: "https://docs.vital-path.com/runbooks/mode3-latency"

      # Mode execution failure rate
      - alert: ModeExecutionFailureRate
        expr: |
          rate(mode2_executions_total{status="error"}[5m]) / 
          rate(mode2_executions_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          component: mode2
        annotations:
          summary: "Mode 2 failure rate exceeds 5%"
          description: "Failure rate is {{ $value | humanizePercentage }}"
          runbook_url: "https://docs.vital-path.com/runbooks/mode-execution-errors"

  - name: user_agent_operations
    interval: 60s
    rules:
      # User agent operation errors
      - alert: UserAgentOperationErrors
        expr: |
          rate(user_agent_operations_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: user_agents
          operation: "{{ $labels.operation }}"
        annotations:
          summary: "User agent operation errors detected"
          description: "Error rate: {{ $value | humanize }} ops/sec for operation {{ $labels.operation }}, Error: {{ $labels.error_type }}"
          runbook_url: "https://docs.vital-path.com/runbooks/user-agent-errors"

