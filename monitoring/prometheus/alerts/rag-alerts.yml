# RAG Monitoring Alerting Rules
# Critical alerts for RAG operations, costs, and service health

groups:
  - name: rag_latency
    interval: 30s
    rules:
      # P95 latency exceeds 2s SLO
      - alert: RAGLatencyHigh
        expr: rag_latency_p95_milliseconds > 2000
        for: 5m
        labels:
          severity: warning
          component: rag
          slo: latency
        annotations:
          summary: "RAG P95 latency exceeds 2s SLO"
          description: "P95 latency is {{ $value }}ms (target: <2000ms). This may impact user experience."
          runbook_url: "https://docs.vital-path.com/runbooks/rag-latency-high"

      # P99 latency exceeds 5s SLO
      - alert: RAGLatencyCritical
        expr: rag_latency_p99_milliseconds > 5000
        for: 2m
        labels:
          severity: critical
          component: rag
          slo: latency
        annotations:
          summary: "RAG P99 latency exceeds 5s SLO"
          description: "P99 latency is {{ $value }}ms (target: <5000ms). Immediate investigation required."
          runbook_url: "https://docs.vital-path.com/runbooks/rag-latency-critical"

      # Cache hit rate too low
      - alert: RAGCacheHitRateLow
        expr: rag_cache_hit_rate < 0.2
        for: 10m
        labels:
          severity: warning
          component: rag
          optimization: cache
        annotations:
          summary: "RAG cache hit rate below 20%"
          description: "Cache hit rate is {{ $value | humanizePercentage }}. Consider increasing TTL or checking cache configuration."
          runbook_url: "https://docs.vital-path.com/runbooks/rag-cache-low"

  - name: rag_cost
    interval: 60s
    rules:
      # Daily budget at 80%
      - alert: RAGDailyBudgetWarning
        expr: rag_budget_daily_usage_percent > 80
        for: 5m
        labels:
          severity: warning
          component: rag
          cost: budget
        annotations:
          summary: "RAG daily budget at {{ $value }}%"
          description: "Daily budget usage is at {{ $value }}%. Review expensive queries or increase budget."
          runbook_url: "https://docs.vital-path.com/runbooks/rag-budget-warning"

      # Daily budget exceeded
      - alert: RAGDailyBudgetExceeded
        expr: rag_budget_daily_usage_percent >= 100
        for: 1m
        labels:
          severity: critical
          component: rag
          cost: budget
        annotations:
          summary: "RAG daily budget exceeded"
          description: "Daily budget has been exceeded. RAG operations may be rate-limited."
          runbook_url: "https://docs.vital-path.com/runbooks/rag-budget-exceeded"

      # Monthly budget at 80%
      - alert: RAGMonthlyBudgetWarning
        expr: rag_budget_monthly_usage_percent > 80
        for: 30m
        labels:
          severity: warning
          component: rag
          cost: budget
        annotations:
          summary: "RAG monthly budget at {{ $value }}%"
          description: "Monthly budget usage is at {{ $value }}%. Plan capacity for rest of month."
          runbook_url: "https://docs.vital-path.com/runbooks/rag-budget-warning"

      # High cost per query
      - alert: RAGCostPerQueryHigh
        expr: rag_cost_per_query_usd > 0.05
        for: 15m
        labels:
          severity: warning
          component: rag
          cost: optimization
        annotations:
          summary: "RAG cost per query exceeds $0.05"
          description: "Average cost per query is ${{ $value }}. Review strategy selection and model usage."
          runbook_url: "https://docs.vital-path.com/runbooks/rag-cost-high"

  - name: rag_circuit_breakers
    interval: 30s
    rules:
      # Circuit breaker OPEN (critical failure)
      - alert: RAGCircuitBreakerOpen
        expr: rag_circuit_breaker_state == 2
        for: 1m
        labels:
          severity: critical
          component: rag
          health: circuit_breaker
        annotations:
          summary: "Circuit breaker OPEN for {{ $labels.service }}"
          description: "Service {{ $labels.service }} circuit breaker is OPEN. Using fallback responses."
          runbook_url: "https://docs.vital-path.com/runbooks/circuit-breaker-open"

      # Circuit breaker testing recovery (HALF_OPEN)
      - alert: RAGCircuitBreakerHalfOpen
        expr: rag_circuit_breaker_state == 1
        for: 2m
        labels:
          severity: warning
          component: rag
          health: circuit_breaker
        annotations:
          summary: "Circuit breaker HALF_OPEN for {{ $labels.service }}"
          description: "Service {{ $labels.service }} is testing recovery. Monitor closely."
          runbook_url: "https://docs.vital-path.com/runbooks/circuit-breaker-half-open"

      # High failure rate
      - alert: RAGHighFailureRate
        expr: |
          (
            rate(rag_circuit_breaker_failures_total[5m]) /
            rate(rag_circuit_breaker_requests_total[5m])
          ) > 0.1
        for: 5m
        labels:
          severity: warning
          component: rag
          health: failure_rate
        annotations:
          summary: "High failure rate for {{ $labels.service }}"
          description: "Failure rate is {{ $value | humanizePercentage }} for {{ $labels.service }}. Investigate errors."
          runbook_url: "https://docs.vital-path.com/runbooks/high-failure-rate"

      # Service rejecting requests
      - alert: RAGRequestsRejected
        expr: rate(rag_circuit_breaker_rejected_total[5m]) > 0
        for: 2m
        labels:
          severity: warning
          component: rag
          health: rejected
        annotations:
          summary: "Requests rejected by {{ $labels.service }}"
          description: "{{ $labels.service }} is rejecting requests (circuit open). Check service health."
          runbook_url: "https://docs.vital-path.com/runbooks/requests-rejected"

  - name: rag_availability
    interval: 60s
    rules:
      # No queries in last hour (possible service issue)
      - alert: RAGNoQueriesDetected
        expr: rate(rag_queries_total[1h]) == 0
        for: 1h
        labels:
          severity: warning
          component: rag
          health: availability
        annotations:
          summary: "No RAG queries detected in last hour"
          description: "RAG service may be unavailable or not receiving traffic. Verify service health."
          runbook_url: "https://docs.vital-path.com/runbooks/no-queries"

      # Cohere re-ranking degraded
      - alert: CohereRerankingDegraded
        expr: |
          (
            rate(rag_circuit_breaker_successes_total{service="cohere"}[10m]) /
            (rate(rag_circuit_breaker_successes_total{service="cohere"}[10m]) +
             rate(rag_circuit_breaker_failures_total{service="cohere"}[10m]))
          ) < 0.9
        for: 10m
        labels:
          severity: warning
          component: rag
          service: cohere
        annotations:
          summary: "Cohere re-ranking success rate below 90%"
          description: "Cohere re-ranking success rate is {{ $value | humanizePercentage }}. Check API status."
          runbook_url: "https://docs.vital-path.com/runbooks/cohere-degraded"
